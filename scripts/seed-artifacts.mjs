import { createClient } from '@supabase/supabase-js';
import { fileURLToPath } from 'url';
import { dirname, resolve } from 'path';
import { readFileSync } from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const envPath = resolve(__dirname, '../.env.local');
try {
  const envContents = readFileSync(envPath, 'utf-8');
  for (const line of envContents.split('\n')) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#')) continue;
    const [key, ...rest] = trimmed.split('=');
    if (!key) continue;
    const value = rest.join('=');
    if (!(key in process.env)) {
      process.env[key] = value;
    }
  }
} catch {
  // Optional
}

const SUPABASE_URL = process.env.VITE_SUPABASE_URL || 'http://127.0.0.1:54321';
const SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!SERVICE_ROLE_KEY) {
  console.error('Missing SUPABASE_SERVICE_ROLE_KEY for artifact upload.');
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
  auth: { persistSession: false },
});

const docEntries = [
  { bpmnFile: 'mortgage.bpmn', title: 'Mortgage' },
  { bpmnFile: 'mortgage-se-application.bpmn', title: 'Mortgage Application' },
  { bpmnFile: 'mortgage-se-credit-evaluation.bpmn', title: 'Credit Evaluation' },
  { bpmnFile: 'mortgage-se-household.bpmn', title: 'Household' },
  { bpmnFile: 'mortgage-se-stakeholder.bpmn', title: 'Stakeholder' },
];

const testEntries = [
  {
    path: 'tests/application.spec.ts',
    title: 'Application happy path',
  },
  {
    path: 'tests/credit-evaluation.spec.ts',
    title: 'Credit evaluation thresholds',
  },
  {
    path: 'tests/stakeholder.spec.ts',
    title: 'Stakeholder onboarding validations',
  },
];

async function uploadDocs() {
  for (const entry of docEntries) {
    const base = entry.bpmnFile.replace('.bpmn', '');
    const path = `docs/${base}.html`;
    const html = `<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>${entry.title} Documentation</title>
    <style>
      body { font-family: system-ui, -apple-system, sans-serif; padding: 2rem; max-width: 800px; margin: auto; line-height: 1.6; }
      h1 { color: #0f172a; }
      section { margin-bottom: 2rem; }
      code { background: #f1f5f9; padding: 0.2rem 0.4rem; border-radius: 4px; }
    </style>
  </head>
  <body>
    <h1>${entry.title}</h1>
    <section>
      <p>Placeholder documentation for <strong>${entry.bpmnFile}</strong>. Replace this with real content when available.</p>
      <ul>
        <li><strong>Process owner:</strong> TBD</li>
        <li><strong>Last updated:</strong> ${new Date().toISOString()}</li>
      </ul>
    </section>
    <section>
      <h2>Summary</h2>
      <p>This autogenerated page ensures Supabase storage contains the required HTML artifact so that documentation links in the UI resolve.</p>
    </section>
  </body>
</html>`;

    const { error } = await supabase.storage
      .from('bpmn-files')
      .upload(path, new TextEncoder().encode(html), {
        upsert: true,
        cacheControl: '3600',
        contentType: 'text/html; charset=utf-8',
      });

    if (error) {
      console.error(`Failed to upload ${path}:`, error.message);
      process.exit(1);
    }
    console.log(`Uploaded documentation ${path}`);
  }
}

async function uploadTests() {
  for (const entry of testEntries) {
    const content = `import { test, expect } from '@playwright/test';

test('${entry.title}', async ({ page }) => {
  // Placeholder test content for ${entry.path}
  await page.goto('/');
  await expect(page).toHaveTitle(/BPMN Viewer/);
});
`;

    const { error } = await supabase.storage
      .from('bpmn-files')
      .upload(entry.path, new TextEncoder().encode(content), {
        upsert: true,
        cacheControl: '3600',
        contentType: 'text/plain; charset=utf-8',
      });

    if (error) {
      console.error(`Failed to upload ${entry.path}:`, error.message);
      process.exit(1);
    }
    console.log(`Uploaded test file ${entry.path}`);
  }
}

async function seedArtifacts() {
  await uploadDocs();
  await uploadTests();
  console.log('Artifact upload complete.');
}

seedArtifacts().catch((err) => {
  console.error('Unexpected artifact upload error:', err);
  process.exit(1);
});
