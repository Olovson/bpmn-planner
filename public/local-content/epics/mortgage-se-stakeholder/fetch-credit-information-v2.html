<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fetch credit information</title>
  <style>
    :root {
      color-scheme: light;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --card-bg: #ffffff;
      --primary: #1d4ed8;
      --text-strong: #0f172a;
      --text-muted: #475569;
      --border: #e2e8f0;
      --accent: #dbeafe;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #ffffff;
      color: var(--text-strong);
      line-height: 1.7;
    }
    .doc-shell {
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.5rem;
      margin: 0 0 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }
    h2 {
      color: var(--primary);
      margin: 24px 0 12px;
      font-size: 1.1rem;
    }
    p { margin: 0 0 12px; }
    ul { padding-left: 20px; margin: 0 0 12px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      background: var(--card-bg);
      border: 1px solid var(--border);
    }
    table th,
    table td {
      border-bottom: 1px solid var(--border);
      padding: 8px;
      text-align: left;
    }
    table th {
      background: var(--accent);
      color: var(--primary);
      font-weight: 600;
    }
    table tr:last-child td {
      border-bottom: none;
    }
    .muted { color: var(--text-muted); font-size: 0.9rem; }
    a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }
    a:hover { text-decoration: underline; }
    .doc-section {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border);
    }
    .doc-section + .doc-section { margin-top: 16px; }
    .doc-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent);
      color: var(--primary);
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .llm-fallback-banner {
      padding: 8px 12px;
      margin-bottom: 16px;
      border-radius: 6px;
      background-color: #fefce8;
      color: #854d0e;
      border: 1px solid #fef9c3;
      font-size: 0.85rem;
    }
    .llm-fallback-badge {
      display: inline-block;
      padding: 4px 8px;
      margin-bottom: 12px;
      border-radius: 4px;
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .llm-fallback-details {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 16px;
      white-space: pre-wrap;
    }
    .llm-fallback-local-note {
      font-size: 0.8rem;
      color: #2563eb;
      margin-bottom: 16px;
    }
    .mermaid {
      margin: 16px 0;
      text-align: center;
    }
    details {
      margin: 12px 0;
    }
    details summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--primary);
      padding: 8px;
      background: var(--accent);
      border-radius: 4px;
    }
    details summary:hover {
      background: #bfdbfe;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true, theme: 'default' });
  </script>
</head>
<body>
  <div class="doc-shell">
    
    
    
    <div class="doc-badge">üìÑ Lokal version ‚Äì F√∂rb√§ttrat inneh√•ll</div>

    <section class="doc-section">
      <h1>Epic ‚Äì Fetch credit information</h1>
      <ul>
        <li><strong>Epic-namn:</strong> Fetch credit information</li>
        <li><strong>BPMN-fil:</strong> mortgage-se-stakeholder.bpmn</li>
        <li><strong>Element ID:</strong> fetch-credit-information</li>
        <li><strong>Nodtyp:</strong> serviceTask</li>
        <li><strong>Version:</strong> 1.0 (exempel) ‚Äì uppdateras vid √§ndring</li>
        <li><strong>√Ñgare:</strong> Produktteam Kredit / Arkitektur</li>
        <li><strong>Confluence:</strong> <a href="#confluence-link">#confluence-link</a></li>
      </ul>
    </section>

    <section class="doc-section">
      <h2>Syfte & V√§rde</h2>
      <p class="muted">Beskrivning av epikens syfte och aff√§rsv√§rde.</p>
      <div class="card">
        <p>Epiken h√§mtar kreditupplysning fr√•n externa kreditupplysningsf√∂retag som UC, Bisnode, eller Creditsafe. Denna information inkluderar kundens kreditscore, betalningsanm√§rkningar, skulder, och kredithistorik. Epiken k√∂rs automatiskt efter att samtycke till kreditupplysning har givits och evaluate-personal-information har returnerat APPROVED. Kreditupplysningen √§r kritisk f√∂r kreditbed√∂mningen och anv√§nds i efterf√∂ljande steg som assess-stakeholder f√∂r att bed√∂ma kundens kreditv√§rdighet och riskprofil.</p>
      </div>
    </section>

    <section class="doc-section">
      <h2>Processkontext</h2>
      <p class="muted">Var epicen befinner sig i Application-processen.</p>
      <div class="card">
        <p>Epiken <strong>fetch-credit-information</strong> √§r en del av <strong>stakeholder</strong> subprocessen i <strong>mortgage-se-application</strong> processen. Den k√∂rs efter <strong>evaluate-personal-information</strong> n√§r gateway "is-personal-information-rejected" returnerar "No" (approved). Efter att kreditupplysning har h√§mtats forts√§tter processen till <strong>assess-stakeholder</strong> f√∂r borrower capacity evaluation.</p>
        
        <details>
          <summary>Application Process Flow</summary>
          <div class="mermaid">
flowchart TD
    Start[Application Start]
    InternalData[internal-data-gathering<br/>subprocess]
    Gateway1[Parallel Gateway]
    Household[household<br/>subprocess]
    Stakeholders[stakeholders<br/>subprocess]
    Object[object<br/>subprocess]
    Gateway2[Parallel Gateway]
    Confirm[confirm-application]
    End[Application End]
    
    Start --> InternalData
    InternalData --> Gateway1
    Gateway1 -->|Parallel| Household
    Gateway1 -->|Parallel| Stakeholders
    Stakeholders --> Object
    Household --> Gateway2
    Stakeholders --> Gateway2
    Object --> Gateway2
    Gateway2 -->|All complete| Confirm
    Confirm --> End
    
    style Stakeholders fill:#1d4ed8,color:#fff
    style FetchCredit fill:#3b82f6,color:#fff
          </div>
          <p class="muted">Application Process Flow visar √∂vergripande fl√∂de: Application startar ‚Üí internal-data-gathering ‚Üí parallellt household och stakeholders ‚Üí object ‚Üí confirm-application.</p>
        </details>
        
        <details>
          <summary>Stakeholder Subprocess Flow</summary>
          <div class="mermaid">
flowchart LR
    Start[Start Event]
    HasConsented{has-consented-to-<br/>credit-check?}
    Consent[consent-to-credit-check<br/>userTask]
    DidConsent{did-consent?}
    Gateway[Gateway Merge]
    FetchPersonal[fetch-personal-information<br/>serviceTask]
    Evaluate[evaluate-personal-information<br/>businessRuleTask]
    Gateway2{is-personal-information-<br/>rejected?}
    FetchCredit[fetch-credit-information<br/>serviceTask]
    Assess[assess-stakeholder<br/>businessRuleTask]
    Gateway3{is-stakeholder-<br/>rejected?}
    Register[register-personal-economy-<br/>information<br/>userTask]
    End[End Event]
    Rejected1[Rejected credit check]
    Rejected2[Rejected personal<br/>information]
    Rejected3[Rejected stakeholder<br/>evaluation]
    
    Start --> HasConsented
    HasConsented -->|No| Consent
    HasConsented -->|Yes| Gateway
    Consent --> DidConsent
    DidConsent -->|Yes| Gateway
    DidConsent -->|No| Rejected1
    Gateway --> FetchPersonal
    FetchPersonal --> Evaluate
    Evaluate --> Gateway2
    Gateway2 -->|No| FetchCredit
    Gateway2 -->|Yes| Rejected2
    FetchCredit --> Assess
    Assess --> Gateway3
    Gateway3 -->|No| Register
    Gateway3 -->|Yes| Rejected3
    Register --> End
    
    style FetchPersonal fill:#3b82f6,color:#fff
    style Consent fill:#3b82f6,color:#fff
    style Evaluate fill:#f59e0b,color:#fff
    style FetchCredit fill:#3b82f6,color:#fff
    style Assess fill:#f59e0b,color:#fff
    style Register fill:#3b82f6,color:#fff
    style HasConsented fill:#fbbf24,color:#000
    style DidConsent fill:#fbbf24,color:#000
    style Gateway2 fill:#fbbf24,color:#000
    style Gateway3 fill:#fbbf24,color:#000
    style Rejected1 fill:#ef4444,color:#fff
    style Rejected2 fill:#ef4444,color:#fff
    style Rejected3 fill:#ef4444,color:#fff
          </div>
          <p class="muted">Stakeholder Subprocess Flow visar: Start ‚Üí has-consented-to-credit-check ‚Üí consent-to-credit-check (om No) ‚Üí did-consent ‚Üí fetch-personal-information ‚Üí evaluate-personal-information ‚Üí fetch-credit-information ‚Üí assess-stakeholder ‚Üí register-personal-economy-information (om approved).</p>
        </details>
        
        <h3>F√∂reg√•ende steg</h3>
        <ul>
          <li><strong>evaluate-personal-information:</strong> M√•ste returnera APPROVED (is-personal-information-rejected = No) f√∂r att fetch-credit-information ska k√∂ras</li>
          <li><strong>fetch-personal-information:</strong> H√§mtar personnummer som anv√§nds f√∂r att h√§mta kreditupplysning</li>
        </ul>
        
        <h3>Efterf√∂ljande steg</h3>
        <ul>
          <li><strong>assess-stakeholder:</strong> Anv√§nder kreditupplysning f√∂r borrower capacity evaluation och DTI-ratio ber√§kning</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Anv√§ndarupplevelse</h2>
      <p class="muted">Beskrivning av anv√§ndarupplevelsen f√∂r b√•de s√∂kande (kund) och anst√§lld (r√•dgivare/admin).</p>
      
      <h3>S√∂kande (Kund)</h3>
      <div class="card">
        <ul>
          <li><strong>Vad ser anv√§ndaren:</strong> Detta √§r en bakgrundsprocess (serviceTask) som k√∂rs automatiskt. Kunden ser ingen direkt UI, men processen p√•verkar vilken kreditupplysning som kan h√§mtas och anv√§ndas i kreditbed√∂mningen.</li>
          <li><strong>Steg:</strong> 
            <ul>
              <li>Processen triggas automatiskt n√§r evaluate-personal-information har returnerat APPROVED</li><li>Kunden forts√§tter med ans√∂kningsprocessen medan kreditupplysning h√§mtas i bakgrunden</li>
            </ul>
          </li>
          <li><strong>Interaktioner:</strong> Ingen direkt anv√§ndarinteraktion ‚Äì automatisk systemprocess</li>
          <li><strong>Design:</strong> N/A ‚Äì backend-process</li>
          
        </ul>
      </div>
      
      <h3>Anst√§lld (R√•dgivare/Admin)</h3>
      <div class="card">
        <ul>
          <li><strong>Vad ser anv√§ndaren:</strong> Handl√§ggare kan se status f√∂r kreditupplysningen i systemloggar eller admin-gr√§nssnitt. H√§mtad kreditupplysning visas i ans√∂knings√∂versikten och anv√§nds f√∂r att bed√∂ma kundens kreditv√§rdighet och riskprofil.</li>
          <li><strong>Steg:</strong> 
            <ul>
              <li>Systemet h√§mtar kreditupplysning automatiskt n√§r evaluate-personal-information har returnerat APPROVED</li><li>Handl√§ggare ser h√§mtad kreditupplysning i ans√∂knings√∂versikten f√∂r bed√∂mning</li><li>Vid fel eller avvikelser kan handl√§ggare se felmeddelanden och vidta √•tg√§rder</li>
            </ul>
          </li>
          <li><strong>Interaktioner:</strong> Granska kreditupplysning, Bed√∂ma kreditv√§rdighet, Fels√∂k vid problem</li>
          <li><strong>Design:</strong> <a href="#figma-link">[L√§nk till Figma-design]</a></li>
          
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Funktionellt fl√∂de</h2>
      <p class="muted">Steg-f√∂r-steg beskrivning av processen.</p>
      <div class="card">
        <ol>
          <li>Epiken triggas automatiskt n√§r evaluate-personal-information har returnerat APPROVED och personinformation √§r tillg√§nglig.</li><li>Systemet identifierar kundens personnummer fr√•n personinformation eller stakeholder-data.</li><li>Ett API-anrop g√∂rs till UC, Bisnode, eller Creditsafe f√∂r att h√§mta kreditupplysning baserat p√• personnummer.</li><li>Kreditupplysningen inkluderar kreditscore, betalningsanm√§rkningar, skulder, kredithistorik, och eventuella varningar.</li><li>H√§mtad data valideras mot f√∂rv√§ntat format och kompletteras med metadata (t.ex. h√§mtningstidpunkt, datak√§lla, dataversion).</li><li>Kreditupplysning sparas i processens datastore och g√∂rs tillg√§nglig f√∂r efterf√∂ljande steg (assess-stakeholder).</li><li>Om h√§mtningen lyckas, forts√§tter processen till n√§sta steg. Vid fel loggas informationen och processen kan avbrytas eller skickas till manuell hantering.</li>
        </ol>
        <p><strong>Beslutslogik:</strong> Epiken √§r en serviceTask utan egna gateways. Den k√∂rs sekventiellt efter evaluate-personal-information och m√•ste slutf√∂ras framg√•ngsrikt f√∂r att efterf√∂ljande steg ska kunna k√∂ras.</p>
        <p><strong>Felhantering:</strong> Vid timeout eller fel fr√•n kreditupplysningsf√∂retag ska systemet logga felet med detaljerad information (felkod, meddelande, timestamp). Vid tillf√§lliga fel kan retry-logik implementeras med exponentiell backoff. Om kunden inte hittas i kreditupplysningsregister kan processen flaggas f√∂r manuell verifiering eller kund kan ombedjas att kontakta kreditupplysningsf√∂retag.</p>
        <p><strong>Edge cases:</strong> Nya kunder utan kredithistorik (kan kr√§va manuell bed√∂mning), kunder med flera personnummer eller namn√§ndringar, historiska data som kan vara inaktuella, kunder med √§ndrad personnummer eller namn√§ndringar, data fr√•n olika kreditupplysningsf√∂retag som kan vara inkonsistenta, kunder som v√§grat kreditupplysning tidigare.</p>
      </div>
      
      <details>
        <summary>Sekvensdiagram - H√§mtning av kreditupplysning</summary>
        <div class="mermaid">
sequenceDiagram
    participant Camunda as BPMN Engine<br/>(Camunda)
    participant API as API Service<br/>(Fetch Credit Info)
    participant Consent as Consent Check<br/>Service
    participant UC as UC/Bisnode/Creditsafe
    participant Validator as Validation Service
    participant Store as Credit Data Store
    
    Note over Camunda: Triggas efter<br/>evaluate-personal-information
    Camunda->>API: Exekvera fetch-credit-information
    API->>API: Identifiera personnummer<br/>fr√•n personinformation
    
    API->>Consent: Verifiera samtycke<br/>(personnummer)
    Consent-->>API: Samtycke verifierat
    
    API->>UC: REST API: H√§mta kreditupplysning<br/>(personnummer)
    UC-->>API: Kreditupplysning<br/>(kreditscore, betalningsanm√§rkningar,<br/>skulder, kredithistorik)
    
    API->>Validator: Validera data<br/>(format, obligatoriska f√§lt)
    Validator-->>API: Valideringsresultat
    
    alt Validering lyckas
        API->>Store: Spara kreditupplysning<br/>+ metadata
        Store-->>API: Bekr√§ftelse
        API->>Camunda: Success + kreditupplysning
        Camunda->>Camunda: Publicera event f√∂r<br/>assess-stakeholder
    else Validering misslyckas
        API->>Camunda: Error + felmeddelande
        Camunda->>Camunda: Flagga f√∂r manuell hantering
    end
    
    alt API-timeout eller n√§tverksfel
        API->>API: Retry med exponentiell backoff
        API->>UC: Retry API-anrop
        UC-->>API: Kreditupplysning
        API->>Store: Spara kreditupplysning
    else Fallback till annat kreditupplysningsf√∂retag
        API->>API: V√§xla till Bisnode/Creditsafe
        API->>UC: API-anrop till alternativ k√§lla
        UC-->>API: Kreditupplysning
        API->>Store: Spara kreditupplysning
    else Kund hittas inte
        UC-->>API: 404 Not Found
        API->>Camunda: Error: Kund hittas inte
        Camunda->>Camunda: Flagga f√∂r manuell verifiering
    end
        </div>
        <p class="muted">Sekvensdiagram visar tidslinje f√∂r interaktioner: BPMN Engine triggar API Service, som verifierar samtycke, g√∂r REST API-anrop till kreditupplysningsf√∂retag, validerar data, sparar i Data Store, och hanterar fel med retry-logik och fallback mellan olika kreditupplysningsf√∂retag.</p>
      </details>
    </section>

    <section class="doc-section">
      <h2>Inputs & Datak√§llor</h2>
      <p class="muted">Beskrivning av inputs och datak√§llor (interna och externa).</p>
      
      <h3>Inputs</h3>
      <p class="muted">Data som epiken tar emot fr√•n f√∂reg√•ende steg eller anv√§ndaren.</p>
      <table>
        <tr>
          <th>Input</th>
          <th>K√§lla</th>
          <th>Typ</th>
          <th>Obligatoriskt</th>
          <th>Beskrivning</th>
        </tr>
        
        <tr>
          <td>Personnummer</td>
          <td>Fetch-personal-information (serviceTask) eller stakeholder-data</td>
          <td>String</td>
          <td>Ja</td>
          <td>Kundens personnummer f√∂r att identifiera r√§tt person i kreditupplysningsregister</td>
        </tr>
        <tr>
          <td>Samtycke till kreditupplysning</td>
          <td>Consent-to-credit-check (userTask)</td>
          <td>ConsentStatus</td>
          <td>Ja</td>
          <td>Bekr√§ftelse att kunden har gett samtycke till kreditupplysning enligt konsumentkreditlagen</td>
        </tr>
        <tr>
          <td>Personinformation</td>
          <td>Fetch-personal-information (serviceTask)</td>
          <td>PersonalInformation</td>
          <td>Ja</td>
          <td>Grundl√§ggande personinformation f√∂r att verifiera kundidentitet</td>
        </tr>
        <tr>
          <td>Ans√∂knings-ID</td>
          <td>Processkontext</td>
          <td>String/UUID</td>
          <td>Ja</td>
          <td>F√∂r att koppla h√§mtad kreditupplysning till r√§tt ans√∂kan och m√∂jligg√∂ra sp√•rbarhet</td>
        </tr>
      </table>

      <h3>Datak√§llor</h3>
      <p class="muted">System och k√§llor som epiken h√§mtar data fr√•n.</p>
      
      
      <h4>Interna datak√§llor (bankens system)</h4>
      <ul>
        <li><strong>Personal Data Store:</strong> Personinformation fr√•n fetch-personal-information, inklusive personnummer</li>
        <li><strong>Consent Registry:</strong> Register √∂ver samtycken f√∂r att verifiera att samtycke har givits</li>
      </ul>
      

      
      <h4>Externa APIs</h4>
      <ul>
        <li><strong>UC (Upplysningscentralen):</strong> Kreditupplysningsf√∂retag som tillhandah√•ller kreditscore, betalningsanm√§rkningar, skulder, och kredithistorik. Detta √§r en av de prim√§ra datak√§llorna f√∂r kreditupplysning i Sverige.</li>
        <li><strong>Bisnode:</strong> Kreditupplysningsf√∂retag som tillhandah√•ller kompletterande kreditupplysning och riskbed√∂mning.</li>
        <li><strong>Creditsafe:</strong> Kreditupplysningsf√∂retag som tillhandah√•ller kreditupplysning och f√∂retagsinformation.</li>
      </ul>
      

      
      <h4>Databaser</h4>
      <ul>
        <li><strong>Application DB:</strong> PostgreSQL-databas f√∂r ans√∂kningsdata och processkontext</li>
        <li><strong>Credit Data Store:</strong> Lagrar h√§mtad kreditupplysning f√∂r anv√§ndning i efterf√∂ljande steg</li>
      </ul>
      

      
    </section>

    

    <section class="doc-section">
      <h2>Outputs</h2>
      <p class="muted">Data som skapas, uppdateras eller skickas vidare.</p>
      <table>
        <tr>
          <th>Output</th>
          <th>Mottagare</th>
          <th>Typ</th>
          <th>Beskrivning</th>
        </tr>
        
        <tr>
          <td>Kreditupplysning (kreditscore, betalningsanm√§rkningar, skulder, kredithistorik)</td>
          <td>Credit Data Store, efterf√∂ljande steg (assess-stakeholder)</td>
          <td>CreditInformation</td>
          <td>Strukturerad kreditupplysning inklusive kreditscore, betalningsanm√§rkningar, skulder, kredithistorik, och eventuella varningar</td>
        </tr>
        <tr>
          <td>H√§mtningsstatus och metadata</td>
          <td>Processkontext, loggsystem</td>
          <td>CreditFetchStatus</td>
          <td>Status f√∂r h√§mtningen (success/failure), timestamp, datak√§lla (UC/Bisnode/Creditsafe), eventuella varningar eller felmeddelanden</td>
        </tr>
        <tr>
          <td>Validerad kreditv√§rdighet</td>
          <td>Efterf√∂ljande steg</td>
          <td>ValidatedCredit</td>
          <td>Verifierad kreditupplysning som kan anv√§ndas f√∂r att bed√∂ma kundens kreditv√§rdighet och riskprofil i assess-stakeholder</td>
        </tr>
      </table>
    </section>

    
    <section class="doc-section">
      <h2>Arkitektur & Systeminteraktioner</h2>
      <p class="muted">Beskrivning av systemarkitektur, integrationer och teknisk stack.</p>
      <div class="card">
        <ul>
          
          
          <li><strong>System som interagerar:</strong>
            <ul>
              <li><strong>UC / Bisnode / Creditsafe:</strong> Externa kreditupplysningsf√∂retag ‚Äì prim√§r datak√§lla f√∂r kreditupplysning</li>
              <li><strong>Personal Data Store:</strong> Lagrar personinformation fr√•n fetch-personal-information</li>
              <li><strong>Consent Registry:</strong> Register √∂ver samtycken f√∂r att verifiera att samtycke har givits</li>
              <li><strong>Application DB:</strong> PostgreSQL-databas f√∂r ans√∂kningsdata och processkontext</li>
            </ul>
          </li>
          
          <li><strong>Integrationer:</strong>
            <ul>
              <li><strong>API-integrationer:</strong> REST API-anrop till UC, Bisnode, eller Creditsafe f√∂r att h√§mta kreditupplysning. API:et exponerar endpoints f√∂r att s√∂ka kreditupplysning baserat p√• personnummer. St√∂djer filtrering och validering av data. √ñverv√§g fallback mellan olika kreditupplysningsf√∂retag om en k√§lla inte √§r tillg√§nglig.</li>
              <li><strong>Event-integrationer:</strong> Processen triggas n√§r evaluate-personal-information √§r slutf√∂rd. Vid lyckad h√§mtning kan events publiceras f√∂r efterf√∂ljande steg (assess-stakeholder).</li>
              <li><strong>Databas-integrationer:</strong> PostgreSQL f√∂r ans√∂kningsdata. H√§mtad kreditupplysning sparas i Credit Data Store f√∂r anv√§ndning i efterf√∂ljande steg.</li>
            </ul>
          </li>
          
          <li><strong>Teknisk stack:</strong>
            <ul>
              <li>BPMN-processmotor (Camunda) f√∂r orkestrering</li>
              <li>REST-klienter f√∂r API-anrop till kreditupplysningsf√∂retag</li>
              <li>PostgreSQL f√∂r datalagring</li>
              <li>Loggning via centraliserat loggsystem</li>
            </ul>
          </li>
          
          <li><strong>Arkitekturdiagram:</strong>
            <details>
              <summary>C4 System Context Diagram</summary>
              <div class="mermaid">
graph TB
    Customer[üë§ Customer<br/>Kund]
    Handler[üë§ Handler<br/>Handl√§ggare]
    
    Epic[Fetch Credit Information<br/>serviceTask]
    
    UC[UC / Bisnode / Creditsafe<br/>Kreditupplysningsf√∂retag]
    
    PersonalStore[(Personal Data Store<br/>Personinformation)]
    ConsentReg[(Consent Registry<br/>Samtycken)]
    AppDB[(Application DB<br/>PostgreSQL)]
    CreditStore[(Credit Data Store<br/>Kreditupplysning)]
    
    Customer -.->|Triggar via<br/>ans√∂kan| Epic
    Handler -.->|Granskar<br/>resultat| Epic
    
    Epic -->|L√§ser| PersonalStore
    Epic -->|Verifierar| ConsentReg
    Epic -->|REST API<br/>H√§mtar kreditupplysning| UC
    Epic -->|L√§ser/Sparar<br/>ans√∂kningsdata| AppDB
    Epic -->|Sparar<br/>kreditupplysning| CreditStore
    
    style Epic fill:#1d4ed8,color:#fff
    style UC fill:#f59e0b,color:#fff
    style AppDB fill:#10b981,color:#fff
    style CreditStore fill:#10b981,color:#fff
    style PersonalStore fill:#10b981,color:#fff
    style ConsentReg fill:#10b981,color:#fff
              </div>
              <p class="muted">System Context Diagram visar epic i centrum med externa system (UC/Bisnode/Creditsafe), interna system (Application DB, Credit Data Store, Personal Data Store, Consent Registry), och anv√§ndare (Customer, Handler).</p>
            </details>
            
            <details>
              <summary>Komponentdiagram</summary>
              <div class="mermaid">
graph TB
    BPMN[BPMN Engine<br/>Camunda]
    APIService[API Service<br/>Fetch Credit Info]
    RESTClient[REST Client<br/>UC/Bisnode/Creditsafe]
    Validator[Validation Service<br/>Data Validation]
    CreditStore[Credit Data Store<br/>Kreditupplysning]
    ConsentCheck[Consent Check Service<br/>Verifiera samtycke]
    
    BPMN -->|Orkestrerar| APIService
    APIService -->|Anv√§nder| RESTClient
    APIService -->|Anv√§nder| Validator
    APIService -->|Anv√§nder| ConsentCheck
    APIService -->|Sparar data| CreditStore
    
    RESTClient -->|API-anrop| UC[UC / Bisnode / Creditsafe]
    ConsentCheck -->|Verifierar| ConsentReg[(Consent Registry)]
    Validator -->|Validerar| CreditStore
    
    style BPMN fill:#1d4ed8,color:#fff
    style APIService fill:#3b82f6,color:#fff
    style RESTClient fill:#60a5fa,color:#fff
    style Validator fill:#93c5fd,color:#fff
    style CreditStore fill:#10b981,color:#fff
    style ConsentCheck fill:#93c5fd,color:#fff
              </div>
              <p class="muted">Komponentdiagram visar huvudkomponenter: BPMN Engine orkestrerar API Service, som anv√§nder REST Client f√∂r API-anrop, Validation Service f√∂r datavalidering, Consent Check Service f√∂r samtyckesverifiering, och sparar data i Credit Data Store.</p>
            </details>
          </li>
          
        </ul>
      </div>
    </section>
    

    
    <section class="doc-section">
      <h2>API Dokumentation</h2>
      <p class="muted">Beskrivning av API-endpoints som anv√§nds eller exponeras.</p>
      
      
      <h3>API-endpoints (exponerade)</h3>
      <table>
        <tr>
          <th>Endpoint</th>
          <th>Metod</th>
          <th>Request</th>
          <th>Response</th>
          <th>Felkoder</th>
        </tr>
        <tr>
          <td><code>/api/fetch-credit-information</code></td>
          <td>POST</td>
          <td><code>{ "personnummer": "string", "applicationId": "uuid", "consentId": "uuid" }</code></td>
          <td><code>{ "creditInformation": { "kreditscore": "number", "betalningsanm√§rkningar": [...], "skulder": [...], "kredithistorik": [...] }, "status": "success", "metadata": { "datak√§lla": "UC", "timestamp": "ISO8601" } }</code></td>
          <td>400 (Bad Request), 401 (Unauthorized - saknat samtycke), 404 (Not Found), 500 (Server Error), 503 (Service Unavailable)</td>
        </tr>
      </table>
      
      <h3>Externa API:er (anv√§nds)</h3>
      <table>
        <tr>
          <th>API</th>
          <th>Endpoint</th>
          <th>Autentisering</th>
          <th>Rate Limit</th>
          <th>Beskrivning</th>
        </tr>
        <tr>
          <td>UC (Upplysningscentralen)</td>
          <td><code>/api/credit/{personnummer}</code></td>
          <td>API key (X-API-Key header)</td>
          <td>50 requests/minut</td>
          <td>Kreditupplysning (kreditscore, betalningsanm√§rkningar, skulder, kredithistorik)</td>
        </tr>
        <tr>
          <td>Bisnode</td>
          <td><code>/api/credit/{personnummer}</code></td>
          <td>API key (X-API-Key header)</td>
          <td>50 requests/minut</td>
          <td>Alternativ kreditupplysning (anv√§nds som fallback om UC inte √§r tillg√§ngligt)</td>
        </tr>
        <tr>
          <td>Creditsafe</td>
          <td><code>/api/credit/{personnummer}</code></td>
          <td>API key (X-API-Key header)</td>
          <td>50 requests/minut</td>
          <td>Alternativ kreditupplysning (anv√§nds som fallback om UC och Bisnode inte √§r tillg√§ngliga)</td>
        </tr>
      </table>
      
      <h3>Autentisering</h3>
      <div class="card">
        <ul>
          <li><strong>Exponerad endpoint:</strong> Kr√§ver OAuth 2.0 Bearer token i Authorization header</li>
          <li><strong>UC/Bisnode/Creditsafe:</strong> API key i X-API-Key header (hanteras av API Gateway)</li>
          <li><strong>Samtycke:</strong> M√•ste ha giltigt samtycke (consentId) enligt konsumentkreditlagen och GDPR</li>
        </ul>
      </div>
      
      <h3>Felhantering</h3>
      <div class="card">
        <ul>
          <li><strong>400 Bad Request:</strong> Ogiltig input (t.ex. ogiltigt personnummer)</li>
          <li><strong>401 Unauthorized:</strong> Saknat eller ogiltigt samtycke till kreditupplysning</li>
          <li><strong>404 Not Found:</strong> Person hittas inte i kreditupplysningsregister</li>
          <li><strong>500 Server Error:</strong> Internt serverfel</li>
          <li><strong>503 Service Unavailable:</strong> Kreditupplysningsf√∂retag √§r otillg√§ngligt (fallback till n√§sta leverant√∂r, retry med exponentiell backoff)</li>
          <li><strong>Timeout:</strong> 30 sekunder f√∂r externa API-anrop, retry max 3 g√•nger per leverant√∂r</li>
        </ul>
      </div>
    </section>
    

    <section class="doc-section">
      <h2>Aff√§rsregler & Beroenden</h2>
      <p class="muted">Beskrivning av aff√§rsregler, kreditregler och beroenden.</p>
      <div class="card">
        <h3>Aff√§rsregler</h3>
        <ul>
          <li><strong>Konsumentkreditlagen:</strong> Kreditupplysning f√•r endast h√§mtas efter att explicit samtycke har givits. Samtycke m√•ste dokumenteras och sp√•ras f√∂r compliance.</li>
          <li><strong>GDPR:</strong> Kreditupplysning inneh√•ller k√§nslig personuppgifter som ska hanteras enligt GDPR. K√§nslig data ska maskeras i loggar och endast n√∂dv√§ndig data ska sparas.</li>
          <li><strong>Kreditupplysningskrav:</strong> Kreditupplysning √§r obligatorisk f√∂r kreditbed√∂mning. Om kreditupplysning inte kan h√§mtas kan ans√∂kan inte forts√§tta.</li>
          <li><strong>Datakvalitet:</strong> Kreditupplysning fr√•n olika k√§llor kan variera. Systemet b√∂r hantera inkonsistenser och flagga f√∂r manuell granskning vid behov.</li>
          <li><strong>Sp√•rbarhet:</strong> Alla h√§mtningar m√•ste loggas med timestamp, datak√§lla, och eventuella fel f√∂r compliance och efterkontroll.</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Test Information</h2>
      <p class="muted">Beskrivning av testscenarier, testdata och testmilj√∂er.</p>
      <div class="card">
        <h3>Testscenarier</h3>
        <ul>
          <li><strong>Normalfl√∂de med komplett underlag:</strong> Kunden eller handl√§ggaren har l√§mnat kompletta och konsistenta uppgifter som uppfyller grundl√§ggande krav.</li><li><strong>Delvis ofullst√§ndigt eller oklart underlag:</strong> Enstaka uppgifter saknas eller √§r mots√§gelsefulla, men √§rendet bed√∂ms kunna kompletteras utan att avbrytas.</li><li><strong>Tekniskt fel eller kritisk avvikelse:</strong> Centrala data inte kan l√§sas in, valideras eller sparas p√• ett s√§kert s√§tt.</li>
        </ul>

        <h3>Testdata</h3>
        <ul>
          <li>[Beskrivning av testdata som beh√∂vs]</li>
        </ul>

        <h3>Testmilj√∂er</h3>
        <ul>
          <li>[Milj√∂ 1: t.ex. "Local development"]</li>
          <li>[Milj√∂ 2: t.ex. "Staging"]</li>
        </ul>

        <h3>Automatiska tester</h3>
        <p>Aff√§rs-scenarierna EPIC-S1‚ÄìEPIC-S3 ska mappas mot automatiska tester d√§r scenario-ID och namn anv√§nds i testfallens ben√§mningar. Testerna b√∂r t√§cka normalfl√∂de, kompletteringsfall samt tekniska fel eller kritiska avvikelser.</p>
        
      </div>
    </section>

    <section class="doc-section">
      <h2>Felhantering & Edge Cases</h2>
      <p class="muted">Beskrivning av felhantering och edge cases.</p>
      
      <h3>Tekniska fel</h3>
      <div class="card">
        <ul>
          <li><strong>API-timeout:</strong> Vid timeout fr√•n kreditupplysningsf√∂retag (30 sekunder) ska systemet logga felet och implementera retry med exponentiell backoff (max 3 f√∂rs√∂k per leverant√∂r). Om alla retries misslyckas f√∂r en leverant√∂r, fallback till n√§sta leverant√∂r (UC ‚Üí Bisnode ‚Üí Creditsafe).</li>
          <li><strong>N√§tverksfel:</strong> Vid n√§tverksfel (connection refused, DNS failure) ska systemet logga felet med detaljerad information och implementera retry med exponentiell backoff. Om alla retries misslyckas f√∂r en leverant√∂r, fallback till n√§sta leverant√∂r.</li>
          <li><strong>Databasfel:</strong> Vid databasfel (connection timeout, deadlock) ska processen flaggas f√∂r manuell hantering och felet loggas med detaljerad information. √ñverv√§g retry f√∂r tillf√§lliga databasfel.</li>
          <li><strong>Kreditupplysningsf√∂retag-fel:</strong> Vid fel fr√•n kreditupplysningsf√∂retag (503 Service Unavailable, 500 Server Error) ska systemet logga felet och implementera retry med exponentiell backoff. Om alla retries misslyckas f√∂r en leverant√∂r, fallback till n√§sta leverant√∂r.</li>
        </ul>
      </div>
      
      <h3>Aff√§rsrelaterade fel</h3>
      <div class="card">
        <ul>
          <li><strong>Samtycke saknas:</strong> Om samtycke inte finns eller √§r ogiltigt (401 Unauthorized) ska processen avbrytas med tydligt felmeddelande. Kunden b√∂r informeras om att de beh√∂ver ge samtycke f√∂r att forts√§tta.</li>
          <li><strong>Validering:</strong> Om personnummer √§r ogiltigt (felaktigt format eller checksum) ska processen flaggas f√∂r manuell verifiering med tydligt felmeddelande. Kunden kan beh√∂va kontakta banken f√∂r att korrigera informationen.</li>
          <li><strong>Kund hittas inte:</strong> Om kund inte hittas i kreditupplysningsregister (404 Not Found) ska processen flaggas f√∂r manuell verifiering. Detta kan vara f√∂rv√§ntat f√∂r nya kunder eller kunder med ogiltiga personnummer.</li>
          <li><strong>Kund har v√§grat kreditupplysning:</strong> Om kund har v√§grat kreditupplysning ska processen flaggas f√∂r manuell hantering. Kunden b√∂r informeras om konsekvenserna.</li>
          <li><strong>Ofullst√§ndig data:</strong> Om h√§mtad kreditupplysning saknar obligatoriska f√§lt (t.ex. kreditscore saknas) ska processen flaggas f√∂r manuell komplettering. Systemet ska logga vilka f√§lt som saknas.</li>
        </ul>
      </div>
      
      <h3>Edge cases</h3>
      <div class="card">
        <ul>
          <li><strong>Fallback mellan leverant√∂rer:</strong> Om UC inte √§r tillg√§nglig ska systemet automatiskt fallback till Bisnode, och om Bisnode inte √§r tillg√§nglig ska systemet fallback till Creditsafe. Systemet ska logga vilken leverant√∂r som anv√§ndes.</li>
          <li><strong>Olika kreditscore-skala:</strong> Olika kreditupplysningsf√∂retag kan anv√§nda olika kreditscore-skala (t.ex. 0-850 vs 0-1000). Systemet ska normalisera kreditscore till en gemensam skala f√∂r konsistens.</li>
          <li><strong>Nya kunder:</strong> Kunder utan kredithistorik kan sakna kreditscore. Systemet ska hantera detta gracefully och flagga f√∂r manuell bed√∂mning om kreditscore saknas.</li>
          <li><strong>Historiska data:</strong> Kreditupplysning fr√•n olika k√§llor kan vara inkonsistenta och kr√§va manuell granskning. Systemet ska identifiera inkonsistenser och flagga f√∂r manuell verifiering.</li>
          <li><strong>Cache:</strong> Om kreditupplysning √§r cachad (t.ex. h√§mtad inom senaste 24 timmarna) ska systemet anv√§nda cachad data f√∂r att undvika on√∂diga anrop. √ñverv√§g att validera cache-√•lder f√∂r att s√§kerst√§lla att data √§r aktuell.</li>
        </ul>
      </div>
      
      <h3>Retry-strategier</h3>
      <div class="card">
        <ul>
          <li><strong>Exponentiell backoff:</strong> Retry med v√§xande intervall (1s, 2s, 4s) f√∂r tillf√§lliga fel (timeout, 503 Service Unavailable). Max 3 f√∂rs√∂k per leverant√∂r innan fallback till n√§sta leverant√∂r.</li>
          <li><strong>Fallback-strategi:</strong> Om en leverant√∂r misslyckas efter 3 f√∂rs√∂k, fallback till n√§sta leverant√∂r (UC ‚Üí Bisnode ‚Üí Creditsafe). Om alla leverant√∂rer misslyckas flaggas processen f√∂r manuell hantering.</li>
          <li><strong>Retry-kriterier:</strong> Retry endast f√∂r tillf√§lliga fel (timeout, 503, connection refused). Inte f√∂r permanenta fel (400 Bad Request, 404 Not Found, 401 Unauthorized).</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Implementation Notes</h2>
      <p class="muted">Tekniska noteringar, k√§nda begr√§nsningar och framtida f√∂rb√§ttringar.</p>
      <div class="card">
        <ul>
          <li><strong>API-anrop:</strong> Epiken exponeras via BPMN serviceTask och kan anropas via processgr√§nssnitt. API-anrop till kreditupplysningsf√∂retag b√∂r implementeras med retry-logik f√∂r tillf√§lliga fel och timeout-hantering. √ñverv√§g fallback mellan olika kreditupplysningsf√∂retag (UC ‚Üí Bisnode ‚Üí Creditsafe) om en k√§lla inte √§r tillg√§nglig.</li>
          <li><strong>Loggning:</strong> Loggning ska omfatta: personnummer (maskerat), h√§mtningstid, datak√§lla (UC/Bisnode/Creditsafe), eventuella fel eller varningar, och status (success/failure). K√§nslig data (personnummer, kreditscore) b√∂r maskeras i loggar enligt GDPR.</li>
          <li><strong>Prestanda:</strong> API-anrop till kreditupplysningsf√∂retag kan ta 2-5 sekunder. √ñverv√§g asynkron h√§mtning om det tar l√§ngre tid. Cache kan anv√§ndas f√∂r att undvika on√∂diga anrop om samma kunds kreditupplysning h√§mtas flera g√•nger (med rimlig tidsbegr√§nsning).</li>
          <li><strong>Datavalidering:</strong> Validera att h√§mtad kreditupplysning matchar f√∂rv√§ntat format innan sparning. Verifiera att obligatoriska f√§lt finns med (kreditscore, betalningsanm√§rkningar) och att datatyper √§r korrekta. Validera kreditscore (0-850 eller liknande beroende p√• k√§lla).</li>
          <li><strong>Framtida f√∂rb√§ttringar:</strong> √ñverv√§g att aggregera kreditupplysning fr√•n flera k√§llor f√∂r mer komplett bild. St√∂d f√∂r real-time kreditupplysning f√∂r snabbare bed√∂mning. Integration med machine learning f√∂r mer sofistikerad riskbed√∂mning baserat p√• kreditupplysning.</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Relaterade noder</h2>
      <p class="muted">L√§nkar till relaterade epics, feature goals och business rules.</p>
      
      <details>
        <summary>Beroendediagram</summary>
        <div class="mermaid">
flowchart LR
    Previous1[fetch-personal-information<br/>serviceTask]
    Previous2[evaluate-personal-information<br/>businessRuleTask]
    Gateway{is-personal-information-<br/>rejected?}
    Current[fetch-credit-information<br/>serviceTask]
    Next[assess-stakeholder<br/>businessRuleTask]
    Rejected[Rejected personal<br/>information]
    
    Previous1 --> Previous2
    Previous2 --> Gateway
    Gateway -->|No| Current
    Gateway -->|Yes| Rejected
    Current --> Next
    
    style Current fill:#3b82f6,color:#fff
    style Previous1 fill:#3b82f6,color:#fff
    style Previous2 fill:#f59e0b,color:#fff
    style Next fill:#f59e0b,color:#fff
    style Gateway fill:#fbbf24,color:#000
    style Rejected fill:#ef4444,color:#fff
        </div>
        <p class="muted">Beroendediagram visar: fetch-personal-information ‚Üí evaluate-personal-information ‚Üí gateway ‚Üí fetch-credit-information (om approved) ‚Üí assess-stakeholder.</p>
      </details>
      
      <h3>F√∂reg√•ende steg</h3>
      <ul>
        <li><strong>evaluate-personal-information:</strong> M√•ste returnera APPROVED (is-personal-information-rejected = No) f√∂r att fetch-credit-information ska k√∂ras</li>
        <li><strong>fetch-personal-information:</strong> H√§mtar personnummer som anv√§nds f√∂r att h√§mta kreditupplysning</li>
      </ul>
      
      <h3>Efterf√∂ljande steg</h3>
      <ul>
        <li><strong>assess-stakeholder:</strong> Anv√§nder kreditupplysning f√∂r borrower capacity evaluation och DTI-ratio ber√§kning</li>
      </ul>
      
      <h3>Parallella steg</h3>
      <ul>
        <li><strong>fetch-engagements:</strong> K√∂rs parallellt i internal-data-gathering subprocessen (anv√§nds tillsammans med kreditupplysning f√∂r DTI-ratio ber√§kning)</li>
      </ul>
      
      <h3>Business Rules</h3>
      <ul>
        <li><strong>Konsumentkreditlagen:</strong> Kr√§ver explicit samtycke innan kreditupplysning kan g√∂ras</li>
        <li><strong>GDPR:</strong> Kreditupplysning ska hanteras enligt GDPR och bankens dataskyddspolicy</li>
      </ul>
    </section>

    <section class="doc-section">
      <h2>BPMN ‚Äì Process (Bild)</h2>
      <p class="muted">Bild av BPMN-processen som epiken refererar till.</p>
      <div class="card">
        <p><strong>BPMN-diagram:</strong></p>
        <p><a href="#/bpmn/mortgage-se-stakeholder.bpmn">Visa BPMN-processen</a></p>
        <p class="muted">[Beskrivning av BPMN-processen eller l√§nk till BPMN-viewer. Bilden ska visa noden och dess kontext i processen.]</p>
      </div>
    </section>
  
  </div>
</body>
</html>