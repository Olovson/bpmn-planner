<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Consent to credit check</title>
  <style>
    :root {
      color-scheme: light;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --card-bg: #ffffff;
      --primary: #1d4ed8;
      --text-strong: #0f172a;
      --text-muted: #475569;
      --border: #e2e8f0;
      --accent: #dbeafe;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #ffffff;
      color: var(--text-strong);
      line-height: 1.7;
    }
    .doc-shell {
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.5rem;
      margin: 0 0 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }
    h2 {
      color: var(--primary);
      margin: 24px 0 12px;
      font-size: 1.1rem;
    }
    p { margin: 0 0 12px; }
    ul { padding-left: 20px; margin: 0 0 12px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      background: var(--card-bg);
      border: 1px solid var(--border);
    }
    table th,
    table td {
      border-bottom: 1px solid var(--border);
      padding: 8px;
      text-align: left;
    }
    table th {
      background: var(--accent);
      color: var(--primary);
      font-weight: 600;
    }
    table tr:last-child td {
      border-bottom: none;
    }
    .muted { color: var(--text-muted); font-size: 0.9rem; }
    a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }
    a:hover { text-decoration: underline; }
    .doc-section {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border);
    }
    .doc-section + .doc-section { margin-top: 16px; }
    .doc-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent);
      color: var(--primary);
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .llm-fallback-banner {
      padding: 8px 12px;
      margin-bottom: 16px;
      border-radius: 6px;
      background-color: #fefce8;
      color: #854d0e;
      border: 1px solid #fef9c3;
      font-size: 0.85rem;
    }
    .llm-fallback-badge {
      display: inline-block;
      padding: 4px 8px;
      margin-bottom: 12px;
      border-radius: 4px;
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .llm-fallback-details {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 16px;
      white-space: pre-wrap;
    }
    .llm-fallback-local-note {
      font-size: 0.8rem;
      color: #2563eb;
      margin-bottom: 16px;
    }
    .mermaid {
      margin: 16px 0;
      text-align: center;
    }
    details {
      margin: 12px 0;
    }
    details summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--primary);
      padding: 8px;
      background: var(--accent);
      border-radius: 4px;
    }
    details summary:hover {
      background: #bfdbfe;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true, theme: 'default' });
  </script>
</head>
<body>
  <div class="doc-shell">
    
    
    
    <div class="doc-badge">üìÑ Lokal version ‚Äì F√∂rb√§ttrat inneh√•ll</div>

    <section class="doc-section">
      <h1>Epic ‚Äì Consent to credit check</h1>
      <ul>
        <li><strong>Epic-namn:</strong> Consent to credit check</li>
        <li><strong>BPMN-fil:</strong> mortgage-se-stakeholder.bpmn</li>
        <li><strong>Element ID:</strong> consent-to-credit-check</li>
        <li><strong>Nodtyp:</strong> userTask</li>
        <li><strong>Version:</strong> 1.0 (exempel) ‚Äì uppdateras vid √§ndring</li>
        <li><strong>√Ñgare:</strong> Produktteam Kredit / Arkitektur</li>
        <li><strong>Confluence:</strong> <a href="#confluence-link">#confluence-link</a></li>
      </ul>
    </section>

    <section class="doc-section">
      <h2>Syfte & V√§rde</h2>
      <p class="muted">Beskrivning av epikens syfte och aff√§rsv√§rde.</p>
      <div class="card">
        <p>Epiken ger kunden eller meds√∂kande m√∂jlighet att ge explicit samtycke till att banken g√∂r en kreditupplysning. Detta √§r ett kritiskt steg som kr√§vs enligt konsumentkreditlagen och GDPR innan banken kan h√§mta kreditupplysning fr√•n UC, Bisnode, eller liknande kreditupplysningsf√∂retag. Kunden m√•ste f√• tydlig information om vad kreditupplysningen inneb√§r, varf√∂r den beh√∂vs, och vilka r√§ttigheter kunden har. Epiken s√§kerst√§ller att samtycke √§r dokumenterat, sp√•rbart, och kan anv√§ndas som juridiskt underlag f√∂r kreditupplysningen.</p>
      </div>
    </section>

    <section class="doc-section">
      <h2>Processkontext</h2>
      <p class="muted">Var epicen befinner sig i Application-processen.</p>
      <div class="card">
        <p>Epiken <strong>consent-to-credit-check</strong> √§r en del av <strong>stakeholder</strong> subprocessen i <strong>mortgage-se-application</strong> processen. Den k√∂rs n√§r gateway "has-consented-to-credit-check" returnerar "No", vilket indikerar att kunden inte redan har gett samtycke. Efter att samtycke har givits (eller om det redan finns) forts√§tter processen till <strong>fetch-personal-information</strong> och <strong>fetch-credit-information</strong>.</p>
        
        <details>
          <summary>Application Process Flow</summary>
          <div class="mermaid">
flowchart TD
    Start[Application Start]
    InternalData[internal-data-gathering<br/>subprocess]
    Gateway1[Parallel Gateway]
    Household[household<br/>subprocess]
    Stakeholders[stakeholders<br/>subprocess]
    Object[object<br/>subprocess]
    Gateway2[Parallel Gateway]
    Confirm[confirm-application]
    End[Application End]
    
    Start --> InternalData
    InternalData --> Gateway1
    Gateway1 -->|Parallel| Household
    Gateway1 -->|Parallel| Stakeholders
    Stakeholders --> Object
    Household --> Gateway2
    Stakeholders --> Gateway2
    Object --> Gateway2
    Gateway2 -->|All complete| Confirm
    Confirm --> End
    
    style Stakeholders fill:#1d4ed8,color:#fff
    style Consent fill:#3b82f6,color:#fff
          </div>
          <p class="muted">Application Process Flow visar √∂vergripande fl√∂de: Application startar ‚Üí internal-data-gathering ‚Üí parallellt household och stakeholders ‚Üí object ‚Üí confirm-application.</p>
        </details>
        
        <details>
          <summary>Stakeholder Subprocess Flow</summary>
          <div class="mermaid">
flowchart LR
    Start[Start Event]
    HasConsented{has-consented-to-<br/>credit-check?}
    Consent[consent-to-credit-check<br/>userTask]
    DidConsent{did-consent?}
    Gateway[Gateway Merge]
    FetchPersonal[fetch-personal-information<br/>serviceTask]
    Evaluate[evaluate-personal-information<br/>businessRuleTask]
    Gateway2{is-personal-information-<br/>rejected?}
    FetchCredit[fetch-credit-information<br/>serviceTask]
    Assess[assess-stakeholder<br/>businessRuleTask]
    Gateway3{is-stakeholder-<br/>rejected?}
    Register[register-personal-economy-<br/>information<br/>userTask]
    End[End Event]
    Rejected1[Rejected credit check]
    Rejected2[Rejected personal<br/>information]
    Rejected3[Rejected stakeholder<br/>evaluation]
    
    Start --> HasConsented
    HasConsented -->|No| Consent
    HasConsented -->|Yes| Gateway
    Consent --> DidConsent
    DidConsent -->|Yes| Gateway
    DidConsent -->|No| Rejected1
    Gateway --> FetchPersonal
    FetchPersonal --> Evaluate
    Evaluate --> Gateway2
    Gateway2 -->|No| FetchCredit
    Gateway2 -->|Yes| Rejected2
    FetchCredit --> Assess
    Assess --> Gateway3
    Gateway3 -->|No| Register
    Gateway3 -->|Yes| Rejected3
    Register --> End
    
    style Consent fill:#3b82f6,color:#fff
    style FetchPersonal fill:#3b82f6,color:#fff
    style Evaluate fill:#f59e0b,color:#fff
    style FetchCredit fill:#3b82f6,color:#fff
    style Assess fill:#f59e0b,color:#fff
    style Register fill:#3b82f6,color:#fff
    style HasConsented fill:#fbbf24,color:#000
    style DidConsent fill:#fbbf24,color:#000
    style Gateway2 fill:#fbbf24,color:#000
    style Gateway3 fill:#fbbf24,color:#000
    style Rejected1 fill:#ef4444,color:#fff
    style Rejected2 fill:#ef4444,color:#fff
    style Rejected3 fill:#ef4444,color:#fff
          </div>
          <p class="muted">Stakeholder Subprocess Flow visar: Start ‚Üí has-consented-to-credit-check ‚Üí consent-to-credit-check (om No) ‚Üí did-consent ‚Üí fetch-personal-information ‚Üí evaluate-personal-information ‚Üí fetch-credit-information ‚Üí assess-stakeholder ‚Üí register-personal-economy-information (om approved).</p>
        </details>
        
        <h3>F√∂reg√•ende steg</h3>
        <ul>
          <li><strong>Start Event:</strong> Stakeholder subprocess startar</li>
          <li><strong>Gateway "has-consented-to-credit-check":</strong> Kontrollerar om samtycke redan finns. Om "No" ‚Üí consent-to-credit-check k√∂rs</li>
        </ul>
        
        <h3>Efterf√∂ljande steg</h3>
        <ul>
          <li><strong>Gateway "did-consent":</strong> Kontrollerar om kunden gav samtycke. Om "Yes" ‚Üí processen forts√§tter, om "No" ‚Üí processen avslutas med "Rejected credit check"</li>
          <li><strong>fetch-personal-information:</strong> K√∂rs efter att samtycke har givits (via Gateway Merge)</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Anv√§ndarupplevelse</h2>
      <p class="muted">Beskrivning av anv√§ndarupplevelsen f√∂r b√•de s√∂kande (kund) och anst√§lld (r√•dgivare/admin).</p>
      
      <h3>S√∂kande (Kund)</h3>
      <div class="card">
        <ul>
          <li><strong>Vad ser anv√§ndaren:</strong> Kunden ser en informationssida med tydlig f√∂rklaring av vad kreditupplysning inneb√§r, varf√∂r den beh√∂vs, vilka upplysningar som h√§mtas, och vilka r√§ttigheter kunden har. Informationen presenteras enligt konsumentkreditlagen med tydlig text och l√§nkar till mer information.</li>
          <li><strong>Steg:</strong> 
            <ul>
              <li>Kunden √∂ppnar samtyckessidan och l√§ser information om kreditupplysning</li><li>Kunden f√•r se tydlig information om vad som h√§mtas, varf√∂r, och vilka r√§ttigheter som finns</li><li>Kunden kan v√§lja att ge samtycke (Ja) eller avb√∂ja (Nej)</li><li>Vid samtycke forts√§tter processen till fetch-personal-information</li><li>Vid avslag stoppas processen och kunden informeras om konsekvenserna</li>
            </ul>
          </li>
          <li><strong>Interaktioner:</strong> L√§sa information, Ge samtycke (Ja/Nej), Ladda ner information som PDF, St√§lla fr√•gor via chat eller telefon</li>
          <li><strong>Design:</strong> <a href="#figma-link">[L√§nk till Figma-design]</a></li>
          
        </ul>
        
        <details>
          <summary>User Journey Map</summary>
          <div class="mermaid">
flowchart LR
    Start[Start<br/>√ñppna samtyckesida]
    Read[L√§sa information<br/>om kreditupplysning]
    Decide{Ge samtycke?<br/>Ja/Nej}
    Consent[Samtycke<br/>sparas]
    Continue[Forts√§tt process<br/>fetch-personal-information]
    Reject[Avslag<br/>Process stoppas]
    
    Start -->|Laddar informationssida| Read
    Read -->|L√§ser| Decide
    Decide -->|Ja| Consent
    Decide -->|Nej| Reject
    Consent -->|Sparar| Continue
    
    style Start fill:#dbeafe,color:#000
    style Read fill:#bfdbfe,color:#000
    style Decide fill:#fbbf24,color:#000
    style Consent fill:#10b981,color:#fff
    style Continue fill:#059669,color:#fff
    style Reject fill:#ef4444,color:#fff
          </div>
          <p class="muted">User Journey Map visar kundens resa fr√•n start till bekr√§ftelse, inklusive touchpoints och tidslinje.</p>
        </details>
        
        <details>
          <summary>Interaktionsfl√∂de</summary>
          <div class="mermaid">
sequenceDiagram
    participant User as Kund/Handl√§ggare
    participant UI as UI Samtyckesida
    participant API as API Service
    participant Store as Consent Store
    
    User->>UI: √ñppna samtyckesida
    UI->>API: H√§mta samtyckesinformation
    API-->>UI: Information om kreditupplysning
    UI-->>User: Visar informationssida
    
    User->>UI: L√§ser information om kreditupplysning
    User->>UI: V√§ljer "Ge samtycke" eller "Avb√∂j"
    
    alt Ge samtycke
        UI->>API: Spara samtycke
        API->>Store: Spara samtycke + timestamp + metadata
        Store-->>API: Bekr√§ftelse
        API-->>UI: Success
        UI-->>User: Bekr√§ftelse + forts√§tt till fetch-personal-information
    else Avb√∂j
        UI->>API: Spara avslag
        API->>Store: Spara avslag + timestamp
        Store-->>API: Bekr√§ftelse
        API-->>UI: Avslag sparad
        UI-->>User: Avslag + process stoppas + konsekvenser
    end
          </div>
          <p class="muted">Interaktionsfl√∂de visar UI-sk√§rmar/steg, anv√§ndarinteraktioner, systemresponser, valideringar och felhantering.</p>
        </details>
      </div>
      
      <h3>Anst√§lld (R√•dgivare/Admin)</h3>
      <div class="card">
        <ul>
          <li><strong>Vad ser anv√§ndaren:</strong> Handl√§ggare ser samma informationssida som kunden, men med ytterligare administrativa funktioner. Handl√§ggare kan se om kunden har gett samtycke, n√§r samtycket gavs, och eventuella kommentarer eller flaggor.</li>
          <li><strong>Steg:</strong> 
            <ul>
              <li>Handl√§ggare √∂ppnar ans√∂kan och ser samtyckesstatus</li><li>Handl√§ggare kan se om kunden har gett samtycke eller om det v√§ntar p√• kundens √•tg√§rd</li><li>Vid avslag kan handl√§ggare se motivering och informera kunden om konsekvenserna</li><li>Handl√§ggare kan ge samtycke √• kundens v√§gnar vid behov (med r√§tt beh√∂righet och dokumentation)</li>
            </ul>
          </li>
          <li><strong>Interaktioner:</strong> Granska samtyckesstatus, Se n√§r samtycke gavs, Ge samtycke √• kundens v√§gnar (vid behov), Se motivering vid avslag</li>
          <li><strong>Design:</strong> <a href="#figma-link">[L√§nk till Figma-design]</a></li>
          
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Funktionellt fl√∂de</h2>
      <p class="muted">Steg-f√∂r-steg beskrivning av processen.</p>
      <div class="card">
        <ol>
          <li>Epiken triggas n√§r stakeholder-processen startar och kunden eller meds√∂kande beh√∂ver ge samtycke till kreditupplysning.</li><li>Systemet presenterar informationssida med tydlig f√∂rklaring av vad kreditupplysning inneb√§r, varf√∂r den beh√∂vs, och vilka r√§ttigheter kunden har enligt konsumentkreditlagen.</li><li>Kunden l√§ser informationen och v√§ljer att ge samtycke (Ja) eller avb√∂ja (Nej).</li><li>Systemet validerar att samtycke √§r korrekt dokumenterat med timestamp, anv√§ndar-ID, och IP-adress f√∂r sp√•rbarhet.</li><li>Beroende p√• val: Vid samtycke (Ja) ‚Üí processen forts√§tter till fetch-personal-information. Vid avslag (Nej) ‚Üí processen stoppas och kunden informeras om att ans√∂kan inte kan forts√§tta utan kreditupplysning.</li><li>Gateway "did-consent-to-credit-check" anv√§nder resultatet f√∂r att avg√∂ra n√§sta steg.</li>
        </ol>
        <p><strong>Beslutslogik:</strong> Epiken √§r en userTask d√§r anv√§ndaren m√•ste ge samtycke. Gateway "did-consent-to-credit-check" anv√§nder resultatet f√∂r att avg√∂ra om processen ska forts√§tta (Yes ‚Üí fetch-personal-information) eller stoppas (No ‚Üí processen avslutas med fel). Gateway "has-consented-to-credit-check" kan ocks√• kontrollera om samtycke redan finns fr√•n tidigare.</p>
        <p><strong>Felhantering:</strong> Om anv√§ndaren avbryter eller st√§nger sidan sparas status som "v√§ntar p√• samtycke" och anv√§ndaren kan √•terkomma senare. Om systemfel uppst√•r vid sparning av samtycke loggas felet och anv√§ndaren informeras. Samtycke kan inte ges om obligatorisk information saknas.</p>
        <p><strong>Edge cases:</strong> Kunder som redan har gett samtycke i tidigare ans√∂kan (kan √•teranv√§ndas om det √§r giltigt), kunder som ger samtycke men sedan √•ngrar sig (kan kr√§va s√§rskild hantering), meds√∂kande som m√•ste ge separat samtycke, kunder som inte f√∂rst√•r informationen (kan kr√§va manuell f√∂rklaring), tekniska problem som g√∂r att samtycke inte kan sparas.</p>
      </div>
      
      <details>
        <summary>Process Flow Diagram</summary>
        <div class="mermaid">
flowchart TD
    Start[Start<br/>Epik triggas]
    LoadInfo[Ladda informationssida<br/>om kreditupplysning]
    Read[L√§s information<br/>+ r√§ttigheter]
    Decide{Ge samtycke?<br/>Ja/Nej}
    SaveConsent[Spara samtycke<br/>+ timestamp]
    SaveReject[Spara avslag<br/>+ timestamp]
    Continue[Forts√§tt process<br/>fetch-personal-information]
    Stop[Stoppa process<br/>+ informera om konsekvenser]
    
    Start --> LoadInfo
    LoadInfo --> Read
    Read --> Decide
    Decide -->|Ja| SaveConsent
    Decide -->|Nej| SaveReject
    SaveConsent --> Continue
    SaveReject --> Stop
    
    style Start fill:#1d4ed8,color:#fff
    style LoadInfo fill:#3b82f6,color:#fff
    style Read fill:#60a5fa,color:#fff
    style Decide fill:#fbbf24,color:#000
    style SaveConsent fill:#10b981,color:#fff
    style SaveReject fill:#ef4444,color:#fff
    style Continue fill:#059669,color:#fff
    style Stop fill:#dc2626,color:#fff
        </div>
        <p class="muted">Process Flow Diagram visar steg-f√∂r-steg fl√∂de: ladda information, l√§s, beslutsgateway (Ja/Nej), spara samtycke eller avslag, och forts√§tt eller stopp process.</p>
      </details>
    </section>

    <section class="doc-section">
      <h2>Inputs & Datak√§llor</h2>
      <p class="muted">Beskrivning av inputs och datak√§llor (interna och externa).</p>
      
      <h3>Inputs</h3>
      <p class="muted">Data som epiken tar emot fr√•n f√∂reg√•ende steg eller anv√§ndaren.</p>
      <table>
        <tr>
          <th>Input</th>
          <th>K√§lla</th>
          <th>Typ</th>
          <th>Obligatoriskt</th>
          <th>Beskrivning</th>
        </tr>
        
        <tr>
          <td>Stakeholder-information (personnummer, namn)</td>
          <td>F√∂reg√•ende steg i stakeholder-processen</td>
          <td>StakeholderData</td>
          <td>Ja</td>
          <td>Grundl√§ggande information om kunden eller meds√∂kande som ska ge samtycke</td>
        </tr>
        <tr>
          <td>Ans√∂knings-ID</td>
          <td>Processkontext</td>
          <td>String/UUID</td>
          <td>Ja</td>
          <td>F√∂r att koppla samtycke till r√§tt ans√∂kan</td>
        </tr>
        <tr>
          <td>Befintligt samtycke (om tillg√§ngligt)</td>
          <td>Tidigare ans√∂kningar eller session</td>
          <td>ConsentStatus</td>
          <td>Nej</td>
          <td>Om kunden redan har gett samtycke i tidigare ans√∂kan kan detta √•teranv√§ndas om det √§r giltigt</td>
        </tr>
      </table>

      <h3>Datak√§llor</h3>
      <p class="muted">System och k√§llor som epiken h√§mtar data fr√•n.</p>
      
      
      <h4>Interna datak√§llor (bankens system)</h4>
      <ul>
        <li><strong>Application DB:</strong> Ans√∂kningsdata och stakeholder-information</li>
        <li><strong>Consent Registry:</strong> Register √∂ver tidigare samtycken f√∂r att kontrollera om giltigt samtycke redan finns</li>
      </ul>
      

      
      <h4>Externa APIs</h4>
      <ul>
        <li>Inga externa APIs ‚Äì all data h√§mtas fr√•n interna system. Kreditupplysning g√∂rs i efterf√∂ljande steg (fetch-credit-information) efter att samtycke har givits.</li>
      </ul>
      

      
      <h4>Databaser</h4>
      <ul>
        <li><strong>Application DB:</strong> PostgreSQL-databas f√∂r ans√∂kningsdata och processkontext</li>
        <li><strong>Consent DB:</strong> Databas f√∂r lagring av samtycken med sp√•rbarhet (timestamp, anv√§ndar-ID, IP-adress)</li>
      </ul>
      

      
    </section>

    

    <section class="doc-section">
      <h2>Outputs</h2>
      <p class="muted">Data som skapas, uppdateras eller skickas vidare.</p>
      <table>
        <tr>
          <th>Output</th>
          <th>Mottagare</th>
          <th>Typ</th>
          <th>Beskrivning</th>
        </tr>
        
        <tr>
          <td>Samtycke till kreditupplysning (Ja/Nej)</td>
          <td>Gateway "did-consent-to-credit-check", efterf√∂ljande steg</td>
          <td>ConsentStatus</td>
          <td>Explicit samtycke fr√•n kunden eller meds√∂kande, dokumenterat med timestamp, anv√§ndar-ID, och IP-adress f√∂r sp√•rbarhet</td>
        </tr>
        <tr>
          <td>Samtyckesmetadata</td>
          <td>Consent DB, processkontext</td>
          <td>ConsentMetadata</td>
          <td>Information om n√§r samtycke gavs, vem som gav det, IP-adress, och eventuella kommentarer eller flaggor</td>
        </tr>
        <tr>
          <td>Validerad samtyckesstatus</td>
          <td>Efterf√∂ljande steg (fetch-personal-information, fetch-credit-information)</td>
          <td>ValidatedConsent</td>
          <td>Status som anv√§nds av gateway "did-consent-to-credit-check" f√∂r att avg√∂ra om processen ska forts√§tta eller stoppas</td>
        </tr>
      </table>
    </section>

    
    <section class="doc-section">
      <h2>Arkitektur & Systeminteraktioner</h2>
      <p class="muted">Beskrivning av systemarkitektur, integrationer och teknisk stack.</p>
      <div class="card">
        <ul>
          
          
          
          <li><strong>System som interagerar:</strong>
            <ul>
              <li><strong>Application DB:</strong> PostgreSQL-databas f√∂r ans√∂kningsdata och processkontext</li>
              <li><strong>Consent Registry:</strong> Register f√∂r lagring och validering av samtycken</li>
              <li><strong>Notification Service:</strong> Tj√§nst f√∂r att skicka bekr√§ftelsemeddelanden till kund</li>
            </ul>
          </li>
          
          <li><strong>Integrationer:</strong>
            <ul>
              <li><strong>API-integrationer:</strong> REST API f√∂r att spara samtycke och h√§mta samtyckesstatus. API:et exponerar endpoints f√∂r att ge samtycke, kontrollera befintligt samtycke, och h√§mta samtyckesinformation.</li>
              <li><strong>Event-integrationer:</strong> Processen triggas n√§r stakeholder-processen startar. Vid samtycke publiceras event f√∂r att trigga n√§sta steg (fetch-personal-information). Vid avslag publiceras event f√∂r att stoppa processen.</li>
              <li><strong>Databas-integrationer:</strong> PostgreSQL f√∂r ans√∂kningsdata. Consent DB f√∂r lagring av samtycken med sp√•rbarhet.</li>
            </ul>
          </li>
          
          <li><strong>Teknisk stack:</strong>
            <ul>
              <li>BPMN-processmotor (Camunda) f√∂r orkestrering</li>
              <li>REST API f√∂r anv√§ndarinteraktion</li>
              <li>PostgreSQL f√∂r datalagring</li>
              <li>Frontend-komponenter f√∂r samtyckesvy och information</li>
            </ul>
          </li>
          
          
          
        </ul>
      </div>
    </section>
    

    

    <section class="doc-section">
      <h2>Aff√§rsregler & Beroenden</h2>
      <p class="muted">Beskrivning av aff√§rsregler, kreditregler och beroenden.</p>
      <div class="card">
        <h3>Aff√§rsregler</h3>
        <ul>
          <li><strong>Konsumentkreditlagen:</strong> Kunden m√•ste ge explicit samtycke innan kreditupplysning kan g√∂ras. Information om kreditupplysning m√•ste presenteras enligt lagens krav med tydlig text och l√§nkar till mer information.</li>
          <li><strong>GDPR:</strong> Samtycke m√•ste vara frivilligt, informerat, specifikt, och √•terkallbart. Kunden har r√§tt att √•terkalla samtycke n√§r som helst. Samtycke m√•ste dokumenteras med timestamp och anv√§ndar-ID f√∂r sp√•rbarhet.</li>
          <li><strong>Sp√•rbarhet:</strong> Alla samtycken m√•ste loggas med timestamp, anv√§ndar-ID, IP-adress, och eventuella kommentarer f√∂r juridiskt underlag och compliance.</li>
          <li><strong>Giltighet:</strong> Samtycke √§r giltigt f√∂r aktuell ans√∂kan. Om kunden ger nytt samtycke i ny ans√∂kan m√•ste detta dokumenteras separat. Giltigt samtycke kan √•teranv√§ndas inom rimlig tidsperiod om det √§r aktuellt.</li>
          <li><strong>Avslag:</strong> Vid avslag kan ans√∂kan inte forts√§tta eftersom kreditupplysning √§r obligatorisk f√∂r kreditbed√∂mning. Kunden informeras tydligt om konsekvenserna av avslag.</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Test Information</h2>
      <p class="muted">Beskrivning av testscenarier, testdata och testmilj√∂er.</p>
      <div class="card">
        <h3>Testscenarier</h3>
        <ul>
          <li><strong>EPIC-S1: Normalfl√∂de med komplett underlag:</strong> Kunden l√§ser informationen om kreditupplysning, f√∂rst√•r vad det inneb√§r, och ger samtycke (Ja). Samtycket sparas korrekt med timestamp och metadata. Processen forts√§tter till fetch-personal-information.</li>
          <li><strong>EPIC-S2: Kunden avb√∂jer samtycke:</strong> Kunden l√§ser informationen men v√§ljer att avb√∂ja samtycke (Nej). Systemet informerar kunden om att ans√∂kan inte kan forts√§tta utan kreditupplysning. Processen stoppas och kunden f√•r information om konsekvenserna.</li>
          <li><strong>EPIC-S3: Tekniskt fel eller kritisk avvikelse:</strong> Systemfel uppst√•r vid sparning av samtycke (t.ex. databasfel, timeout). Felet loggas, anv√§ndaren informeras, och samtycket kan sparas igen n√§r felet √§r √•tg√§rdat. Processen v√§ntar p√• att samtycke ska sparas korrekt.</li>
          <li><strong>Edge case: Befintligt samtycke:</strong> Kunden har redan gett samtycke i tidigare ans√∂kan. Systemet kontrollerar om samtycket √§r giltigt och kan √•teranv√§ndas. Om giltigt kan processen forts√§tta utan att kr√§va nytt samtycke.</li>
          <li><strong>Edge case: Meds√∂kande:</strong> Vid flera meds√∂kande m√•ste varje person ge separat samtycke. Systemet hanterar detta genom att presentera samtyckesvy f√∂r varje meds√∂kande individuellt.</li>
        </ul>

        <h3>Testdata</h3>
        <ul>
          <li>Testkunder med olika scenarion: ny kund (inget befintligt samtycke), √•terkommande kund (befintligt samtycke), meds√∂kande (flera personer)</li>
          <li>Olika samtyckesval: Ja (godk√§nner), Nej (avb√∂jer), avbruten (st√§nger sidan)</li>
          <li>Testdata f√∂r olika scenarion: komplett information, ofullst√§ndig information, tekniska fel</li>
        </ul>

        <h3>Testmilj√∂er</h3>
        <ul>
          <li><strong>Local development:</strong> Lokal databas med testdata</li>
          <li><strong>Staging:</strong> Staging-milj√∂ med realistiska testdata</li>
          <li><strong>Integration test:</strong> Test mot isolerad testmilj√∂ med kontrollerade testdata</li>
        </ul>

        <h3>Automatiska tester</h3>
        <p>Aff√§rs-scenarierna EPIC-S1‚ÄìEPIC-S3 ska mappas mot automatiska tester d√§r scenario-ID och namn anv√§nds i testfallens ben√§mningar. Testerna b√∂r t√§cka normalfl√∂de (kund ger samtycke), edge case (kund avb√∂jer), samt tekniska fel (databasfel, timeout). Tester ska verifiera att samtycke sparas korrekt med metadata, att gateway fungerar korrekt, och att processen stoppas vid avslag.</p>
        
      </div>
    </section>

    <section class="doc-section">
      <h2>Felhantering & Edge Cases</h2>
      <p class="muted">Beskrivning av felhantering och edge cases.</p>
      
      <h3>Tekniska fel</h3>
      <div class="card">
        <ul>
          <li><strong>Databasfel:</strong> Vid databasfel n√§r samtycke sparas (connection timeout, deadlock) ska systemet logga felet och flagga processen f√∂r manuell hantering. √ñverv√§g retry f√∂r tillf√§lliga databasfel. Kunden b√∂r informeras om att samtycket inte kunde sparas och att de kan f√∂rs√∂ka igen.</li>
          <li><strong>Session timeout:</strong> Om anv√§ndarens session g√•r ut innan samtycke sparas ska systemet logga felet och informera anv√§ndaren. √ñverv√§g att spara samtycke automatiskt n√§r anv√§ndaren klickar p√• knappen f√∂r att undvika dataf√∂rlust.</li>
          <li><strong>N√§tverksfel:</strong> Vid n√§tverksfel (connection refused, DNS failure) n√§r samtycke sparas ska systemet logga felet och informera anv√§ndaren. √ñverv√§g retry f√∂r tillf√§lliga n√§tverksfel.</li>
        </ul>
      </div>
      
      <h3>Aff√§rsrelaterade fel</h3>
      <div class="card">
        <ul>
          <li><strong>Kund avb√∂jer samtycke:</strong> Om kunden v√§ljer "Nej" √§r detta ett f√∂rv√§ntat aff√§rsrelaterat val och ska hanteras gracefully. Processen avslutas med tydligt meddelande om att ans√∂kan inte kan forts√§tta utan samtycke.</li>
          <li><strong>Samtycke saknas:</strong> Om samtycke inte kan hittas eller har √•terkallats ska processen avbrytas med tydligt felmeddelande. Kunden b√∂r informeras om att de beh√∂ver ge samtycke f√∂r att forts√§tta.</li>
          <li><strong>Ogiltigt samtycke:</strong> Om samtycke √§r ogiltigt (t.ex. f√∂r gammalt, √•terkallat) ska processen avbrytas med tydligt felmeddelande. Kunden b√∂r informeras om att de beh√∂ver ge nytt samtycke.</li>
          <li><strong>Sp√•rbarhet:</strong> Om samtycke inte kan sparas med korrekt sp√•rbarhet (timestamp, anv√§ndar-ID, IP-adress) ska processen flaggas f√∂r manuell granskning. Detta √§r kritiskt f√∂r compliance och juridiskt underlag.</li>
        </ul>
      </div>
      
      <h3>Edge cases</h3>
      <div class="card">
        <ul>
          <li><strong>Dubbelt samtycke:</strong> Om kunden f√∂rs√∂ker ge samtycke flera g√•nger ska systemet identifiera detta och anv√§nda det f√∂rsta giltiga samtycket. √ñverv√§g att logga alla f√∂rs√∂k f√∂r sp√•rbarhet.</li>
          <li><strong>Samtycke under process:</strong> Om kunden ger samtycke medan processen redan √§r ig√•ng ska systemet hantera detta korrekt. √ñverv√§g att validera samtycke vid varje steg som kr√§ver det.</li>
          <li><strong>√Öterkallat samtycke:</strong> Om kunden √•terkallar samtycke efter att det har givits ska systemet identifiera detta och stoppa processen. Kunden b√∂r informeras om konsekvenserna.</li>
          <li><strong>Giltighetstid:</strong> Om samtycke har g√•tt ut (t.ex. efter 30 dagar) ska systemet identifiera detta och kr√§va nytt samtycke. √ñverv√§g att informera kunden innan samtycket g√•r ut.</li>
        </ul>
      </div>
      
      <h3>Retry-strategier</h3>
      <div class="card">
        <ul>
          <li><strong>Databas:</strong> Retry med exponentiell backoff (1s, 2s, 4s) f√∂r tillf√§lliga databasfel. Max 3 f√∂rs√∂k innan processen flaggas f√∂r manuell hantering.</li>
          <li><strong>Session:</strong> Om session g√•r ut ska systemet informera anv√§ndaren och ge m√∂jlighet att logga in igen. √ñverv√§g att spara samtycke automatiskt f√∂r att undvika dataf√∂rlust.</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Implementation Notes</h2>
      <p class="muted">Tekniska noteringar, k√§nda begr√§nsningar och framtida f√∂rb√§ttringar.</p>
      <div class="card">
        <ul>
          <li><strong>UI/UX:</strong> Informationssidan b√∂r vara tydlig och l√§ttl√§st med information enligt konsumentkreditlagen. Samtyckesknappar (Ja/Nej) b√∂r vara tydliga och l√§tt att f√∂rst√•. √ñverv√§g att inkludera l√§nkar till mer information och m√∂jlighet att ladda ner information som PDF.</li>
          <li><strong>Loggning:</strong> Loggning ska omfatta: n√§r samtycke gavs, vem som gav det (anv√§ndar-ID), IP-adress, val (Ja/Nej), och eventuella kommentarer. Alla samtycken m√•ste loggas f√∂r compliance och juridiskt underlag. K√§nslig data (personnummer) b√∂r maskeras i loggar enligt GDPR.</li>
          <li><strong>Sp√•rbarhet:</strong> Alla samtycken m√•ste sparas med timestamp, anv√§ndar-ID, IP-adress, och eventuella kommentarer f√∂r juridiskt underlag. √ñverv√§g digital signering f√∂r extra s√§kerhet.</li>
          <li><strong>Giltighet:</strong> Validera att samtycke √§r korrekt dokumenterat innan det anv√§nds. Kontrollera att samtycke √§r aktuellt och inte har √•terkallats. √ñverv√§g tidsbegr√§nsning f√∂r samtyckens giltighet.</li>
          <li><strong>Framtida f√∂rb√§ttringar:</strong> √ñverv√§g m√∂jlighet att √•terkalla samtycke √§ven efter att det har givits. St√∂d f√∂r olika typer av samtycke (t.ex. f√∂r olika typer av kreditupplysning). Integration med e-signatur f√∂r digital signering av samtycke.</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Relaterade noder</h2>
      <p class="muted">L√§nkar till relaterade epics, feature goals och business rules.</p>
      
      <details>
        <summary>Beroendediagram</summary>
        <div class="mermaid">
flowchart LR
    Start[Start Event]
    HasConsented{has-consented-to-<br/>credit-check?}
    Current[consent-to-credit-check<br/>userTask]
    DidConsent{did-consent?}
    Gateway[Gateway Merge]
    Next[fetch-personal-information<br/>serviceTask]
    Rejected[Rejected credit check]
    
    Start --> HasConsented
    HasConsented -->|No| Current
    HasConsented -->|Yes| Gateway
    Current --> DidConsent
    DidConsent -->|Yes| Gateway
    DidConsent -->|No| Rejected
    Gateway --> Next
    
    style Current fill:#3b82f6,color:#fff
    style Next fill:#3b82f6,color:#fff
    style HasConsented fill:#fbbf24,color:#000
    style DidConsent fill:#fbbf24,color:#000
    style Rejected fill:#ef4444,color:#fff
        </div>
        <p class="muted">Beroendediagram visar: Start ‚Üí has-consented-to-credit-check ‚Üí consent-to-credit-check (om No) ‚Üí did-consent ‚Üí fetch-personal-information (om Yes) eller rejected (om No).</p>
      </details>
      
      <h3>F√∂reg√•ende steg</h3>
      <ul>
        <li><strong>Start Event:</strong> Stakeholder subprocess startar</li>
        <li><strong>Gateway "has-consented-to-credit-check":</strong> Kontrollerar om samtycke redan finns. Om "No" ‚Üí consent-to-credit-check k√∂rs</li>
      </ul>
      
      <h3>Efterf√∂ljande steg</h3>
      <ul>
        <li><strong>Gateway "did-consent":</strong> Kontrollerar om kunden gav samtycke. Om "Yes" ‚Üí processen forts√§tter, om "No" ‚Üí processen avslutas med "Rejected credit check"</li>
        <li><strong>fetch-personal-information:</strong> K√∂rs efter att samtycke har givits (via Gateway Merge)</li>
      </ul>
      
      <h3>Parallella steg</h3>
      <ul>
        <li><strong>register-household-economy-information:</strong> K√∂rs parallellt i household subprocessen (kr√§ver inte samtycke)</li>
      </ul>
      
      <h3>Business Rules</h3>
      <ul>
        <li><strong>Konsumentkreditlagen:</strong> Kr√§ver explicit samtycke innan kreditupplysning kan g√∂ras</li>
        <li><strong>GDPR:</strong> Samtycke m√•ste vara frivilligt, informerat, specifikt, och √•terkallbart</li>
        <li><strong>Sp√•rbarhet:</strong> Bankens policy kr√§ver sp√•rbarhet av alla samtycken</li>
      </ul>
    </section>

    <section class="doc-section">
      <h2>BPMN ‚Äì Process (Bild)</h2>
      <p class="muted">Bild av BPMN-processen som epiken refererar till.</p>
      <div class="card">
        <p><strong>BPMN-diagram:</strong></p>
        <p><a href="#/bpmn/mortgage-se-stakeholder.bpmn">Visa BPMN-processen</a></p>
        <p class="muted">[Beskrivning av BPMN-processen eller l√§nk till BPMN-viewer. Bilden ska visa noden och dess kontext i processen.]</p>
      </div>
    </section>
  
  </div>
</body>
</html>

