<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fetch BRF-information</title>
  <style>
    :root {
      color-scheme: light;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --card-bg: #ffffff;
      --primary: #1d4ed8;
      --text-strong: #0f172a;
      --text-muted: #475569;
      --border: #e2e8f0;
      --accent: #dbeafe;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #ffffff;
      color: var(--text-strong);
      line-height: 1.7;
    }
    .doc-shell {
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.5rem;
      margin: 0 0 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }
    h2 {
      color: var(--primary);
      margin: 24px 0 12px;
      font-size: 1.1rem;
    }
    p { margin: 0 0 12px; }
    ul { padding-left: 20px; margin: 0 0 12px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      background: var(--card-bg);
      border: 1px solid var(--border);
    }
    table th,
    table td {
      border-bottom: 1px solid var(--border);
      padding: 8px;
      text-align: left;
    }
    table th {
      background: var(--accent);
      color: var(--primary);
      font-weight: 600;
    }
    table tr:last-child td {
      border-bottom: none;
    }
    .muted { color: var(--text-muted); font-size: 0.9rem; }
    a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }
    a:hover { text-decoration: underline; }
    .doc-section {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border);
    }
    .doc-section + .doc-section { margin-top: 16px; }
    .doc-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent);
      color: var(--primary);
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .mermaid {
      margin: 16px 0;
      text-align: center;
    }
    details {
      margin: 12px 0;
    }
    details summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--primary);
      padding: 8px;
      background: var(--accent);
      border-radius: 4px;
    }
    details summary:hover {
      background: #bfdbfe;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true, theme: 'default' });
  </script>
</head>
<body>
  <div class="doc-shell">
    <div class="doc-badge">üìÑ Lokal version ‚Äì F√∂rb√§ttrat inneh√•ll</div>

    <section class="doc-section">
      <h1>Epic ‚Äì Fetch BRF-information</h1>
      <ul>
        <li><strong>Epic-namn:</strong> Fetch BRF-information</li>
        <li><strong>BPMN-fil:</strong> mortgage-se-object-information.bpmn</li>
        <li><strong>Element ID:</strong> fetch-brf-information</li>
        <li><strong>Nodtyp:</strong> serviceTask</li>
        <li><strong>Version:</strong> 1.0</li>
        <li><strong>√Ñgare:</strong> Produktteam Kredit / Arkitektur</li>
        <li><strong>Confluence:</strong> <a href="#confluence-link">#confluence-link</a></li>
      </ul>
    </section>

    <section class="doc-section">
      <h2>Syfte & V√§rde</h2>
      <p class="muted">Beskrivning av epikens syfte och aff√§rsv√§rde.</p>
      <div class="card">
        <p>Epiken h√§mtar BRF-information (Bostadsr√§ttsf√∂rening) fr√•n Bolagsverket, UC BRF-info, eller andra k√§llor f√∂r bostadsr√§ttsf√∂reningar. Denna information inkluderar f√∂reningens organisationsnummer, ekonomiska nyckeltal (f√∂reningsskuld, avgifter, etc.), och andra relevanta BRF-egenskaper. Epiken √§r en kritisk del av object-information subprocessen och s√§kerst√§ller att korrekt BRF-information finns tillg√§nglig f√∂r efterf√∂ljande steg som evaluate-bostadsratt. Genom att centralisera h√§mtningen av BRF-information s√§kerst√§lls konsistens och minskas risken f√∂r felaktig information i senare bed√∂mningar.</p>
      </div>
    </section>

    <section class="doc-section">
      <h2>Processkontext</h2>
      <p class="muted">Var epicen befinner sig i Application-processen.</p>
      <div class="card">
        <p>Epiken <strong>fetch-brf-information</strong> √§r en del av <strong>object-information</strong> subprocessen i <strong>object</strong> subprocessen i <strong>mortgage-se-application</strong> processen. Den k√∂rs efter <strong>fetch-bostadsratts-information</strong> n√§r objekttyp √§r "Bostadsr√§tt". Efter att BRF-information har h√§mtats forts√§tter processen till <strong>evaluate-bostadsratt</strong> f√∂r att bed√∂ma bostadsr√§ttens l√§mplighet som s√§kerhet.</p>
        
        <details>
          <summary>Application Process Flow</summary>
          <div class="mermaid">
flowchart TD
    Start[Application Start]
    InternalData[internal-data-gathering<br/>subprocess]
    Gateway1[Parallel Gateway]
    Household[household<br/>subprocess]
    Stakeholders[stakeholders<br/>subprocess]
    Object[object<br/>subprocess]
    ObjectInfo[object-information<br/>subprocess]
    Gateway2[Parallel Gateway]
    Confirm[confirm-application]
    End[Application End]
    
    Start --> InternalData
    InternalData --> Gateway1
    Gateway1 -->|Parallel| Household
    Gateway1 -->|Parallel| Stakeholders
    Stakeholders --> Object
    Object --> ObjectInfo
    Household --> Gateway2
    Stakeholders --> Gateway2
    Object --> Gateway2
    Gateway2 -->|All complete| Confirm
    Confirm --> End
    
    style Object fill:#1d4ed8,color:#fff
    style ObjectInfo fill:#1d4ed8,color:#fff
    style FetchBRF fill:#3b82f6,color:#fff
          </div>
          <p class="muted">Application Process Flow visar √∂vergripande fl√∂de: Application startar ‚Üí internal-data-gathering ‚Üí parallellt household och stakeholders ‚Üí object ‚Üí object-information ‚Üí confirm-application.</p>
        </details>
        
        <details>
          <summary>Object Information Subprocess Flow</summary>
          <div class="mermaid">
flowchart LR
    Start[Start Event]
    ObjectType{object-type<br/>Gateway}
    FetchFastighet[fetch-fastighets-information<br/>serviceTask]
    EvaluateFastighet[evaluate-fastighet<br/>businessRuleTask]
    FetchBostadsratt[fetch-bostadsratts-information<br/>serviceTask]
    FetchBRF[fetch-brf-information<br/>serviceTask]
    EvaluateBostadsratt[evaluate-bostadsratt<br/>businessRuleTask]
    Gateway[Gateway Merge]
    End[End Event]
    
    Start --> ObjectType
    ObjectType -->|Sm√•hus| FetchFastighet
    ObjectType -->|Bostadsr√§tt| FetchBostadsratt
    FetchFastighet --> EvaluateFastighet
    EvaluateFastighet --> Gateway
    FetchBostadsratt --> FetchBRF
    FetchBRF --> EvaluateBostadsratt
    EvaluateBostadsratt --> Gateway
    Gateway --> End
    
    style FetchFastighet fill:#3b82f6,color:#fff
    style EvaluateFastighet fill:#f59e0b,color:#fff
    style FetchBostadsratt fill:#3b82f6,color:#fff
    style FetchBRF fill:#3b82f6,color:#fff
    style EvaluateBostadsratt fill:#f59e0b,color:#fff
    style ObjectType fill:#fbbf24,color:#000
          </div>
          <p class="muted">Object Information Subprocess Flow visar: Start ‚Üí object-type gateway ‚Üí fetch-fastighets-information (om Sm√•hus) eller fetch-bostadsratts-information (om Bostadsr√§tt) ‚Üí evaluate-fastighet/evaluate-bostadsratt ‚Üí End.</p>
        </details>
        
        <h3>F√∂reg√•ende steg</h3>
        <ul>
          <li><strong>fetch-bostadsratts-information:</strong> M√•ste vara slutf√∂rd f√∂r att bostadsr√§ttsinformation ska vara tillg√§nglig (anv√§nds f√∂r att identifiera BRF)</li>
        </ul>
        
        <h3>Efterf√∂ljande steg</h3>
        <ul>
          <li><strong>evaluate-bostadsratt:</strong> Anv√§nder h√§mtad BRF-information och bostadsr√§ttsinformation f√∂r att bed√∂ma bostadsr√§ttens l√§mplighet som s√§kerhet</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Anv√§ndarupplevelse</h2>
      <p class="muted">Beskrivning av anv√§ndarupplevelsen f√∂r b√•de s√∂kande (kund) och anst√§lld (r√•dgivare/admin).</p>
      
      <h3>S√∂kande (Kund)</h3>
      <div class="card">
        <ul>
          <li><strong>Vad ser anv√§ndaren:</strong> Detta √§r en bakgrundsprocess (serviceTask) som k√∂rs automatiskt. Kunden ser ingen direkt UI, men processen p√•verkar vilken BRF-information som kan h√§mtas och valideras i efterf√∂ljande steg.</li>
          <li><strong>Steg:</strong> 
            <ul>
              <li>Processen triggas automatiskt efter att bostadsr√§ttsinformation har h√§mtats</li><li>Kunden forts√§tter med ans√∂kningsprocessen medan BRF-information h√§mtas i bakgrunden</li>
            </ul>
          </li>
          <li><strong>Interaktioner:</strong> Ingen direkt anv√§ndarinteraktion ‚Äì automatisk systemprocess</li>
          <li><strong>Design:</strong> N/A ‚Äì backend-process</li>
        </ul>
      </div>
      
      <h3>Anst√§lld (R√•dgivare/Admin)</h3>
      <div class="card">
        <ul>
          <li><strong>Vad ser anv√§ndaren:</strong> Handl√§ggare kan se status f√∂r datah√§mtningen i systemloggar eller admin-gr√§nssnitt. H√§mtad BRF-information visas i ans√∂knings√∂versikten och anv√§nds f√∂r att verifiera BRF-data.</li>
          <li><strong>Steg:</strong> 
            <ul>
              <li>Systemet h√§mtar BRF-information automatiskt efter att bostadsr√§ttsinformation har h√§mtats</li><li>Handl√§ggare ser h√§mtad data i ans√∂knings√∂versikten f√∂r verifiering</li><li>Vid fel eller avvikelser kan handl√§ggare se felmeddelanden och vidta √•tg√§rder</li>
            </ul>
          </li>
          <li><strong>Interaktioner:</strong> Granska h√§mtad BRF-information, Verifiera BRF-data, Fels√∂k vid problem</li>
          <li><strong>Design:</strong> <a href="#figma-link">[L√§nk till Figma-design]</a></li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Funktionellt fl√∂de</h2>
      <p class="muted">Steg-f√∂r-steg beskrivning av processen.</p>
      <div class="card">
        <ol>
          <li>Epiken triggas automatiskt n√§r fetch-bostadsratts-information har slutf√∂rts och bostadsr√§ttsinformation √§r tillg√§nglig.</li><li>Systemet identifierar BRF-information (f√∂reningsnummer, organisationsnummer) fr√•n bostadsr√§ttsinformation eller ans√∂kningsdata.</li><li>Ett API-anrop g√∂rs till Bolagsverket, UC BRF-info, eller liknande k√§llor f√∂r att h√§mta BRF-information (f√∂reningsskuld, avgifter, ekonomiska nyckeltal, etc.).</li><li>H√§mtad data valideras mot f√∂rv√§ntat format och kompletteras med metadata (t.ex. h√§mtningstidpunkt, datak√§lla, dataversion).</li><li>BRF-information sparas i processens datastore (BRF information service) och g√∂rs tillg√§nglig f√∂r efterf√∂ljande steg (evaluate-bostadsratt).</li><li>Om h√§mtningen lyckas, forts√§tter processen till n√§sta steg. Vid fel loggas informationen och processen kan avbrytas eller skickas till manuell hantering.</li>
        </ol>
        <p><strong>Beslutslogik:</strong> Epiken √§r en serviceTask utan egna gateways. Den k√∂rs sekventiellt efter fetch-bostadsratts-information och m√•ste slutf√∂ras framg√•ngsrikt f√∂r att efterf√∂ljande steg (evaluate-bostadsratt) ska kunna k√∂ras.</p>
        <p><strong>Felhantering:</strong> Vid timeout eller fel fr√•n BRF-register ska systemet logga felet med detaljerad information (felkod, meddelande, timestamp). Vid tillf√§lliga fel kan retry-logik implementeras med exponentiell backoff. Om BRF-information inte hittas i register kan processen flaggas f√∂r manuell verifiering eller kund kan ombedjas att uppdatera sina uppgifter.</p>
        <p><strong>Edge cases:</strong> Nya BRF:er som inte finns i register (kan kr√§va manuell registrering), BRF:er med flera organisationsnummer (m√•ste identifiera r√§tt), historiska data som kan vara inaktuella, BRF:er med √§ndrade organisationsnummer eller namn, data fr√•n olika k√§llor som kan vara inkonsistenta.</p>
      </div>
      
      <details>
        <summary>Sekvensdiagram - H√§mtning av BRF-information</summary>
        <div class="mermaid">
sequenceDiagram
    participant Camunda as BPMN Engine<br/>(Camunda)
    participant API as API Service<br/>(Fetch BRF Info)
    participant Bolagsverket as Bolagsverket<br/>UC BRF-info
    participant Validator as Validation Service
    participant Store as BRF Information Service
    
    Note over Camunda: Triggas efter<br/>fetch-bostadsratts-information
    Camunda->>API: Exekvera fetch-brf-information
    API->>API: Identifiera BRF-info<br/>(f√∂reningsnummer, organisationsnummer)
    
    API->>Bolagsverket: REST API: H√§mta BRF-info<br/>(organisationsnummer)
    Bolagsverket-->>API: BRF-info<br/>(f√∂reningsskuld, avgifter, nyckeltal)
    
    API->>Validator: Validera data<br/>(format, obligatoriska f√§lt)
    Validator-->>API: Valideringsresultat
    
    alt Validering lyckas
        API->>Store: Spara BRF-info<br/>+ metadata
        Store-->>API: Bekr√§ftelse
        API->>Camunda: Success + BRF-info
        Camunda->>Camunda: Publicera event f√∂r<br/>evaluate-bostadsratt
    else Validering misslyckas
        API->>Camunda: Error + felmeddelande
        Camunda->>Camunda: Flagga f√∂r manuell hantering
    end
    
    alt API-timeout eller fel
        API->>API: Retry med exponentiell backoff
        API->>Bolagsverket: Retry API-anrop
        Bolagsverket-->>API: BRF-info
        API->>Store: Spara BRF-info
    else BRF hittas inte
        Bolagsverket-->>API: 404 Not Found
        API->>Camunda: Error: BRF hittas inte
        Camunda->>Camunda: Flagga f√∂r manuell verifiering
    end
        </div>
        <p class="muted">Sekvensdiagram visar tidslinje f√∂r interaktioner: BPMN Engine triggar API Service, som g√∂r API-anrop till Bolagsverket/UC BRF-info, validerar data, sparar i Data Store, och hanterar fel med retry-logik.</p>
      </details>
    </section>

    <section class="doc-section">
      <h2>Inputs & Datak√§llor</h2>
      <p class="muted">Beskrivning av inputs och datak√§llor (interna och externa).</p>
      
      <h3>Inputs</h3>
      <p class="muted">Data som epiken tar emot fr√•n f√∂reg√•ende steg eller anv√§ndaren.</p>
      <table>
        <tr>
          <th>Input</th>
          <th>K√§lla</th>
          <th>Typ</th>
          <th>Obligatoriskt</th>
          <th>Beskrivning</th>
        </tr>
        <tr>
          <td>BRF-information (f√∂reningsnummer, organisationsnummer)</td>
          <td>Bostadsr√§ttsinformation fr√•n fetch-bostadsratts-information</td>
          <td>String</td>
          <td>Ja</td>
          <td>Identifierare f√∂r att h√§mta r√§tt BRF-information fr√•n Bolagsverket/UC BRF-info</td>
        </tr>
        <tr>
          <td>Bostadsr√§ttsinformation</td>
          <td>Bostadsr√§tt Information Service</td>
          <td>BostadsrattData</td>
          <td>Ja</td>
          <td>F√∂r att koppla BRF-information till r√§tt bostadsr√§tt</td>
        </tr>
        <tr>
          <td>Ans√∂knings-ID</td>
          <td>Processkontext</td>
          <td>String/UUID</td>
          <td>Ja</td>
          <td>F√∂r att koppla h√§mtad data till r√§tt ans√∂kan och m√∂jligg√∂ra sp√•rning</td>
        </tr>
      </table>

      <h3>Datak√§llor</h3>
      <p class="muted">System och k√§llor som epiken h√§mtar data fr√•n.</p>
      
      <h4>Externa datak√§llor</h4>
      <ul>
        <li><strong>Bolagsverket / UC BRF-info:</strong> Register som inneh√•ller BRF-information inklusive organisationsnummer, f√∂reningsskuld, avgifter, ekonomiska nyckeltal, och andra BRF-egenskaper. Detta √§r prim√§r datak√§lla f√∂r BRF-information.</li>
      </ul>
      
      <h4>Databaser</h4>
      <ul>
        <li><strong>Application DB:</strong> Ans√∂kningsdata och processkontext</li>
        <li><strong>BRF Information Service:</strong> Lagrar h√§mtad BRF-information f√∂r anv√§ndning i efterf√∂ljande steg (evaluate-bostadsratt)</li>
        <li><strong>Bostadsr√§tt Information Service:</strong> L√§ser bostadsr√§ttsinformation f√∂r att identifiera BRF</li>
      </ul>
    </section>

    <section class="doc-section">
      <h2>Outputs</h2>
      <p class="muted">Data som skapas, uppdateras eller skickas vidare.</p>
      <table>
        <tr>
          <th>Output</th>
          <th>Mottagare</th>
          <th>Typ</th>
          <th>Beskrivning</th>
        </tr>
        <tr>
          <td>BRF-information (f√∂reningsskuld, avgifter, nyckeltal, etc.)</td>
          <td>BRF Information Service, evaluate-bostadsratt</td>
          <td>BRFData</td>
          <td>H√§mtad BRF-information fr√•n Bolagsverket/UC BRF-info som anv√§nds f√∂r bostadsr√§ttsbed√∂mning</td>
        </tr>
        <tr>
          <td>Metadata (h√§mtningstidpunkt, datak√§lla, dataversion)</td>
          <td>Processkontext, loggsystem</td>
          <td>Metadata</td>
          <td>Metadata om h√§mtningen f√∂r sp√•rning och kvalitetss√§kring</td>
        </tr>
      </table>
    </section>

    <section class="doc-section">
      <h2>Arkitektur & Systeminteraktioner</h2>
      <p class="muted">Beskrivning av systemarkitektur, integrationer och teknisk stack.</p>
      <div class="card">
        <ul>
          <li><strong>System som interagerar:</strong>
            <ul>
              <li><strong>Bolagsverket / UC BRF-info:</strong> Register ‚Äì prim√§r datak√§lla f√∂r BRF-information</li>
              <li><strong>Application DB:</strong> PostgreSQL-databas f√∂r ans√∂kningsdata och processkontext</li>
              <li><strong>BRF Information Service:</strong> Lagrar h√§mtad BRF-information</li>
              <li><strong>Bostadsr√§tt Information Service:</strong> L√§ser bostadsr√§ttsinformation f√∂r att identifiera BRF</li>
            </ul>
          </li>
          
          <li><strong>Integrationer:</strong>
            <ul>
              <li><strong>API-integrationer:</strong> REST API-anrop till Bolagsverket/UC BRF-info f√∂r att h√§mta BRF-information. API:et exponerar endpoints f√∂r att s√∂ka BRF baserat p√• organisationsnummer. St√∂djer filtrering och validering av data.</li>
              <li><strong>Event-integrationer:</strong> Processen triggas av BPMN event efter fetch-bostadsratts-information. Vid lyckad h√§mtning kan events publiceras f√∂r efterf√∂ljande steg.</li>
              <li><strong>Databas-integrationer:</strong> PostgreSQL f√∂r ans√∂kningsdata. H√§mtad BRF-information sparas i BRF Information Service f√∂r anv√§ndning i efterf√∂ljande steg.</li>
            </ul>
          </li>
          
          <li><strong>Teknisk stack:</strong>
            <ul>
              <li>BPMN-processmotor (Camunda) f√∂r orkestrering</li>
              <li>REST-klienter f√∂r API-anrop till Bolagsverket/UC BRF-info</li>
              <li>PostgreSQL f√∂r datalagring</li>
              <li>Loggning via centraliserat loggsystem</li>
            </ul>
          </li>
          
          <li><strong>Arkitekturdiagram:</strong>
            <details>
              <summary>C4 System Context Diagram</summary>
              <div class="mermaid">
graph TB
    Customer[üë§ Customer<br/>Kund]
    Handler[üë§ Handler<br/>Handl√§ggare]
    
    Epic[Fetch BRF Information<br/>serviceTask]
    
    Bolagsverket[Bolagsverket / UC BRF-info<br/>BRF-register]
    
    AppDB[(Application DB<br/>PostgreSQL)]
    BRFStore[(BRF Information Service<br/>BRF-info)]
    BostadsrattStore[(Bostadsr√§tt Information Service<br/>Bostadsr√§ttsinfo)]
    
    Customer -.->|Triggar via<br/>ans√∂kan| Epic
    Handler -.->|Granskar<br/>resultat| Epic
    
    Epic -->|REST API<br/>H√§mtar BRF-info| Bolagsverket
    Epic -->|L√§ser| BostadsrattStore
    Epic -->|L√§ser/Sparar<br/>ans√∂kningsdata| AppDB
    Epic -->|Sparar<br/>BRF-info| BRFStore
    
    style Epic fill:#1d4ed8,color:#fff
    style Bolagsverket fill:#f59e0b,color:#fff
    style AppDB fill:#10b981,color:#fff
    style BRFStore fill:#10b981,color:#fff
    style BostadsrattStore fill:#10b981,color:#fff
              </div>
              <p class="muted">System Context Diagram visar epic i centrum med externa system (Bolagsverket/UC BRF-info), interna system (Application DB, BRF Information Service, Bostadsr√§tt Information Service), och anv√§ndare (Customer, Handler).</p>
            </details>
            
            <details>
              <summary>Komponentdiagram</summary>
              <div class="mermaid">
graph TB
    BPMN[BPMN Engine<br/>Camunda]
    APIService[API Service<br/>Fetch BRF Info]
    RESTClient[REST Client<br/>Bolagsverket/UC BRF-info]
    Validator[Validation Service<br/>Data Validation]
    BRFStore[BRF Information Service<br/>BRF-info]
    BostadsrattStore[Bostadsr√§tt Information Service<br/>Bostadsr√§ttsinfo]
    
    BPMN -->|Orkestrerar| APIService
    APIService -->|Anv√§nder| RESTClient
    APIService -->|L√§ser| BostadsrattStore
    APIService -->|Anv√§nder| Validator
    APIService -->|Sparar data| BRFStore
    
    RESTClient -->|API-anrop| Bolagsverket[Bolagsverket/UC BRF-info]
    Validator -->|Validerar| BRFStore
    
    style BPMN fill:#1d4ed8,color:#fff
    style APIService fill:#3b82f6,color:#fff
    style RESTClient fill:#60a5fa,color:#fff
    style Validator fill:#93c5fd,color:#000
    style BRFStore fill:#10b981,color:#fff
    style BostadsrattStore fill:#10b981,color:#fff
              </div>
              <p class="muted">Komponentdiagram visar huvudkomponenter: BPMN Engine orkestrerar API Service, som anv√§nder REST Client f√∂r API-anrop, l√§ser fr√•n Bostadsr√§tt Information Service, Validation Service f√∂r datavalidering, och sparar data i BRF Information Service.</p>
            </details>
          </li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>API Dokumentation</h2>
      <p class="muted">Beskrivning av API-endpoints som anv√§nds eller exponeras.</p>
      
      <h3>API-endpoints (exponerade)</h3>
      <table>
        <tr>
          <th>Endpoint</th>
          <th>Metod</th>
          <th>Request</th>
          <th>Response</th>
          <th>Felkoder</th>
        </tr>
        <tr>
          <td><code>/api/fetch-brf-information</code></td>
          <td>POST</td>
          <td><code>{ "organisationsnummer": "string", "applicationId": "uuid" }</code></td>
          <td><code>{ "brfInformation": { "organisationsnummer": "string", "f√∂reningsnamn": "string", "f√∂reningsskuld": "number", "avgifter": "number", "ekonomiskaNyckeltal": {...}, ... }, "status": "success", "metadata": { "datak√§lla": "Bolagsverket/UC BRF-info", "timestamp": "ISO8601" } }</code></td>
          <td>400 (Bad Request), 404 (Not Found), 500 (Server Error), 503 (Service Unavailable)</td>
        </tr>
      </table>
      
      <h3>Externa API:er (anv√§nds)</h3>
      <table>
        <tr>
          <th>API</th>
          <th>Endpoint</th>
          <th>Autentisering</th>
          <th>Rate Limit</th>
          <th>Beskrivning</th>
        </tr>
        <tr>
          <td>Bolagsverket</td>
          <td><code>/api/organisation/{organisationsnummer}</code></td>
          <td>API key (X-API-Key header)</td>
          <td>100 requests/minut</td>
          <td>Organisationsregister f√∂r BRF-information (organisationsnummer, f√∂reningsnamn)</td>
        </tr>
        <tr>
          <td>UC BRF-info</td>
          <td><code>/api/brf/{organisationsnummer}</code></td>
          <td>API key (X-API-Key header)</td>
          <td>50 requests/minut</td>
          <td>Ekonomiska nyckeltal f√∂r bostadsr√§ttsf√∂reningar (f√∂reningsskuld, avgifter, ekonomiska nyckeltal)</td>
        </tr>
      </table>
      
      <h3>Autentisering</h3>
      <div class="card">
        <ul>
          <li><strong>Exponerad endpoint:</strong> Kr√§ver OAuth 2.0 Bearer token i Authorization header</li>
          <li><strong>Bolagsverket/UC BRF-info:</strong> API key i X-API-Key header (hanteras av API Gateway)</li>
        </ul>
      </div>
      
      <h3>Felhantering</h3>
      <div class="card">
        <ul>
          <li><strong>400 Bad Request:</strong> Ogiltig input (t.ex. ogiltigt organisationsnummer)</li>
          <li><strong>404 Not Found:</strong> BRF hittas inte i register</li>
          <li><strong>500 Server Error:</strong> Internt serverfel</li>
          <li><strong>503 Service Unavailable:</strong> Extern API √§r otillg√§nglig (retry med exponentiell backoff)</li>
          <li><strong>Timeout:</strong> 30 sekunder f√∂r externa API-anrop, retry max 3 g√•nger</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Felhantering & Edge Cases</h2>
      <p class="muted">Beskrivning av felhantering och edge cases.</p>
      
      <h3>Tekniska fel</h3>
      <div class="card">
        <ul>
          <li><strong>API-timeout:</strong> Vid timeout fr√•n Bolagsverket eller UC BRF-info (30 sekunder) ska systemet logga felet och implementera retry med exponentiell backoff (max 3 f√∂rs√∂k per k√§lla). Om alla retries misslyckas f√∂r en k√§lla, fallback till n√§sta k√§lla.</li>
          <li><strong>N√§tverksfel:</strong> Vid n√§tverksfel (connection refused, DNS failure) ska systemet logga felet med detaljerad information och implementera retry med exponentiell backoff. Om alla retries misslyckas f√∂r en k√§lla, fallback till n√§sta k√§lla.</li>
          <li><strong>Databasfel:</strong> Vid databasfel (connection timeout, deadlock) n√§r BRF-information sparas ska processen flaggas f√∂r manuell hantering och felet loggas med detaljerad information. √ñverv√§g retry f√∂r tillf√§lliga databasfel.</li>
        </ul>
      </div>
      
      <h3>Aff√§rsrelaterade fel</h3>
      <div class="card">
        <ul>
          <li><strong>Validering:</strong> Om organisationsnummer √§r ogiltigt (felaktigt format) ska processen flaggas f√∂r manuell verifiering med tydligt felmeddelande. Kunden kan beh√∂va kontakta banken f√∂r att korrigera informationen.</li>
          <li><strong>BRF hittas inte:</strong> Om BRF inte hittas i Bolagsverket eller UC BRF-info (404 Not Found) ska processen flaggas f√∂r manuell verifiering. Detta kan vara f√∂rv√§ntat f√∂r nya BRF:er eller BRF:er med ogiltiga organisationsnummer.</li>
          <li><strong>Ofullst√§ndig data:</strong> Om h√§mtad BRF-information saknar obligatoriska f√§lt (t.ex. f√∂reningsskuld saknas, avgifter saknas) ska processen flaggas f√∂r manuell komplettering. Systemet ska logga vilka f√§lt som saknas.</li>
        </ul>
      </div>
      
      <h3>Edge cases</h3>
      <div class="card">
        <ul>
          <li><strong>Fallback mellan k√§llor:</strong> Om Bolagsverket inte √§r tillg√§nglig ska systemet automatiskt fallback till UC BRF-info. Systemet ska logga vilken k√§lla som anv√§ndes.</li>
          <li><strong>Nya BRF:er:</strong> Nya BRF:er som inte finns i register kan kr√§va manuell registrering. Systemet ska identifiera detta scenario och flagga f√∂r manuell hantering med tydligt meddelande.</li>
          <li><strong>Historiska data:</strong> Data fr√•n olika k√§llor kan vara inkonsistenta och kr√§va manuell granskning. Systemet ska identifiera inkonsistenser och flagga f√∂r manuell verifiering.</li>
        </ul>
      </div>
      
      <h3>Retry-strategier</h3>
      <div class="card">
        <ul>
          <li><strong>Exponentiell backoff:</strong> Retry med v√§xande intervall (1s, 2s, 4s) f√∂r tillf√§lliga fel (timeout, 503 Service Unavailable). Max 3 f√∂rs√∂k per k√§lla innan fallback till n√§sta k√§lla.</li>
          <li><strong>Fallback-strategi:</strong> Om en k√§lla misslyckas efter 3 f√∂rs√∂k, fallback till n√§sta k√§lla (Bolagsverket ‚Üí UC BRF-info). Om alla k√§llor misslyckas flaggas processen f√∂r manuell hantering.</li>
          <li><strong>Retry-kriterier:</strong> Retry endast f√∂r tillf√§lliga fel (timeout, 503, connection refused). Inte f√∂r permanenta fel (400 Bad Request, 404 Not Found, 401 Unauthorized).</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Relaterade noder</h2>
      <p class="muted">L√§nkar till relaterade epics, feature goals och business rules.</p>
      
      <details>
        <summary>Beroendediagram</summary>
        <div class="mermaid">
flowchart LR
    Previous[evaluate-bostadsratt<br/>businessRuleTask]
    Current[fetch-brf-information<br/>serviceTask]
    ObjectsValid{objects-valid?<br/>Gateway}
    End[Object Information<br/>Subprocess End]
    
    Previous -->|Input till| Current
    Current --> ObjectsValid
    ObjectsValid -->|All/Some/None| End
    
    style Current fill:#3b82f6,color:#fff
    style Previous fill:#f59e0b,color:#fff
    style ObjectsValid fill:#fbbf24,color:#000
        </div>
        <p class="muted">Beroendediagram visar: evaluate-bostadsratt ‚Üí fetch-brf-information ‚Üí objects-valid ‚Üí End.</p>
      </details>
      
      <h3>F√∂reg√•ende steg</h3>
      <ul>
        <li><strong>evaluate-bostadsratt:</strong> M√•ste vara slutf√∂rd f√∂r att organisationsnummer ska vara tillg√§ngligt f√∂r att h√§mta BRF-information</li>
      </ul>
      
      <h3>Efterf√∂ljande steg</h3>
      <ul>
        <li><strong>objects-valid:</strong> Gateway som avg√∂r om objekt √§r giltiga baserat p√• BRF-information (All/Some/None)</li>
        <li><strong>Object Information Subprocess End:</strong> N√§r fetch-brf-information √§r klar slutf√∂rs object-information subprocessen</li>
      </ul>
      
      <h3>Parallella steg</h3>
      <ul>
        <li><strong>fetch-fastighets-information:</strong> K√∂rs parallellt om object-type √§r "Sm√•hus"</li>
      </ul>
      
      <h3>Business Rules</h3>
      <ul>
        <li><strong>Valideringsregler:</strong> BRF-information m√•ste vara korrekt och komplett</li>
        <li><strong>Datak√§llor:</strong> Bolagsverket och UC BRF-info f√∂r ekonomiska nyckeltal</li>
      </ul>
    </section>
  </div>
</body>
</html>

