<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Screen bostadsr√§tt</title>
  <style>
    :root {
      color-scheme: light;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --card-bg: #ffffff;
      --primary: #1d4ed8;
      --text-strong: #0f172a;
      --text-muted: #475569;
      --border: #e2e8f0;
      --accent: #dbeafe;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #ffffff;
      color: var(--text-strong);
      line-height: 1.7;
    }
    .doc-shell {
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.5rem;
      margin: 0 0 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }
    h2 {
      color: var(--primary);
      margin: 24px 0 12px;
      font-size: 1.1rem;
    }
    p { margin: 0 0 12px; }
    ul { padding-left: 20px; margin: 0 0 12px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      background: var(--card-bg);
      border: 1px solid var(--border);
    }
    table th,
    table td {
      border-bottom: 1px solid var(--border);
      padding: 8px;
      text-align: left;
    }
    table th {
      background: var(--accent);
      color: var(--primary);
      font-weight: 600;
    }
    table tr:last-child td {
      border-bottom: none;
    }
    .muted { color: var(--text-muted); font-size: 0.9rem; }
    a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }
    a:hover { text-decoration: underline; }
    .doc-section {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border);
    }
    .doc-section + .doc-section { margin-top: 16px; }
    .doc-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent);
      color: var(--primary);
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .mermaid {
      margin: 16px 0;
      text-align: center;
    }
    details {
      margin: 12px 0;
    }
    details summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--primary);
      padding: 8px;
      background: var(--accent);
      border-radius: 4px;
    }
    details summary:hover {
      background: #bfdbfe;
    }
    .dmn-table {
      margin: 16px 0;
      font-size: 0.9rem;
    }
    .dmn-table th {
      background: var(--primary);
      color: #fff;
      font-weight: 600;
    }
    .dmn-table td {
      vertical-align: top;
    }
    .dmn-input {
      background: #f0f9ff;
    }
    .dmn-output {
      background: #ecfdf5;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true, theme: 'default' });
  </script>
</head>
<body>
  <div class="doc-shell">
    <div class="doc-badge">üìÑ Lokal version ‚Äì F√∂rb√§ttrat inneh√•ll</div>

    <section class="doc-section">
      <h1>Epic ‚Äì Screen bostadsr√§tt</h1>
      <ul>
        <li><strong>Epic-namn:</strong> Screen bostadsr√§tt</li>
        <li><strong>BPMN-fil:</strong> mortgage-se-object-information.bpmn</li>
        <li><strong>Element ID:</strong> evaluate-bostadsratt</li>
        <li><strong>Nodtyp:</strong> businessRuleTask</li>
        <li><strong>Version:</strong> 1.0</li>
        <li><strong>√Ñgare:</strong> Produktteam Kredit / Arkitektur</li>
        <li><strong>Confluence:</strong> <a href="#confluence-link">#confluence-link</a></li>
      </ul>
    </section>

    <section class="doc-section">
      <h2>Syfte & V√§rde</h2>
      <p class="muted">Beskrivning av epikens syfte och aff√§rsv√§rde.</p>
      <div class="card">
        <p>Evaluate bostadsr√§tt √§r en DMN-beslutsregel (businessRuleTask) som evaluerar bostadsr√§ttens l√§mplighet som s√§kerhet f√∂r bol√•net baserat p√• bostadsr√§ttsv√§rde, f√∂reningsskuld, LTV-ratio (loan-to-value), plats, och andra bostadsr√§ttsegenskaper. Regeln utv√§rderar om bostadsr√§tten uppfyller bankens krav f√∂r s√§kerhet och bed√∂mer riskniv√•n. Den analyserar bostadsr√§ttsinformation fr√•n fetch-bostadsratts-information och BRF-information fr√•n fetch-brf-information f√∂r att bed√∂ma bostadsr√§ttens v√§rde och l√§mplighet. Regeln returnerar ett beslut: APPROVED (kan anv√§ndas som s√§kerhet) eller REJECTED (kan inte anv√§ndas som s√§kerhet) tillsammans med riskniv√•. Detta √§r en kritisk del av objektbed√∂mningen och avg√∂r om bostadsr√§tten kan accepteras som s√§kerhet f√∂r l√•net.</p>
      </div>
    </section>

    <section class="doc-section">
      <h2>Processkontext</h2>
      <p class="muted">Var epicen befinner sig i Application-processen.</p>
      <div class="card">
        <p>Epiken <strong>evaluate-bostadsratt</strong> √§r en del av <strong>object-information</strong> subprocessen i <strong>object</strong> subprocessen i <strong>mortgage-se-application</strong> processen. Den k√∂rs efter <strong>fetch-brf-information</strong> n√§r objekttyp √§r "Bostadsr√§tt". Efter att bostadsr√§tten har evaluerats forts√§tter processen till gateway "Gateway_0f8c0ne" (Merge) och sedan till End f√∂r object-information subprocessen.</p>
        
        <details>
          <summary>Application Process Flow</summary>
          <div class="mermaid">
flowchart TD
    Start[Application Start]
    InternalData[internal-data-gathering<br/>subprocess]
    Gateway1[Parallel Gateway]
    Household[household<br/>subprocess]
    Stakeholders[stakeholders<br/>subprocess]
    Object[object<br/>subprocess]
    ObjectInfo[object-information<br/>subprocess]
    Gateway2[Parallel Gateway]
    Confirm[confirm-application]
    End[Application End]
    
    Start --> InternalData
    InternalData --> Gateway1
    Gateway1 -->|Parallel| Household
    Gateway1 -->|Parallel| Stakeholders
    Stakeholders --> Object
    Object --> ObjectInfo
    Household --> Gateway2
    Stakeholders --> Gateway2
    Object --> Gateway2
    Gateway2 -->|All complete| Confirm
    Confirm --> End
    
    style Object fill:#1d4ed8,color:#fff
    style ObjectInfo fill:#1d4ed8,color:#fff
    style EvaluateBostadsratt fill:#f59e0b,color:#fff
          </div>
          <p class="muted">Application Process Flow visar √∂vergripande fl√∂de: Application startar ‚Üí internal-data-gathering ‚Üí parallellt household och stakeholders ‚Üí object ‚Üí object-information ‚Üí confirm-application.</p>
        </details>
        
        <details>
          <summary>Object Information Subprocess Flow</summary>
          <div class="mermaid">
flowchart LR
    Start[Start Event]
    ObjectType{object-type<br/>Gateway}
    FetchFastighet[fetch-fastighets-information<br/>serviceTask]
    EvaluateFastighet[evaluate-fastighet<br/>businessRuleTask]
    FetchBostadsratt[fetch-bostadsratts-information<br/>serviceTask]
    FetchBRF[fetch-brf-information<br/>serviceTask]
    EvaluateBostadsratt[evaluate-bostadsratt<br/>businessRuleTask]
    Gateway[Gateway Merge]
    End[End Event]
    
    Start --> ObjectType
    ObjectType -->|Sm√•hus| FetchFastighet
    ObjectType -->|Bostadsr√§tt| FetchBostadsratt
    FetchFastighet --> EvaluateFastighet
    EvaluateFastighet --> Gateway
    FetchBostadsratt --> FetchBRF
    FetchBRF --> EvaluateBostadsratt
    EvaluateBostadsratt --> Gateway
    Gateway --> End
    
    style FetchFastighet fill:#3b82f6,color:#fff
    style EvaluateFastighet fill:#f59e0b,color:#fff
    style FetchBostadsratt fill:#3b82f6,color:#fff
    style FetchBRF fill:#3b82f6,color:#fff
    style EvaluateBostadsratt fill:#f59e0b,color:#fff
    style ObjectType fill:#fbbf24,color:#000
          </div>
          <p class="muted">Object Information Subprocess Flow visar: Start ‚Üí object-type gateway ‚Üí fetch-fastighets-information (om Sm√•hus) eller fetch-bostadsratts-information (om Bostadsr√§tt) ‚Üí evaluate-fastighet/evaluate-bostadsratt ‚Üí End.</p>
        </details>
        
        <h3>F√∂reg√•ende steg</h3>
        <ul>
          <li><strong>fetch-brf-information:</strong> M√•ste vara slutf√∂rd f√∂r att BRF-information ska vara tillg√§nglig f√∂r evaluering</li>
          <li><strong>fetch-bostadsratts-information:</strong> M√•ste vara slutf√∂rd f√∂r att bostadsr√§ttsinformation ska vara tillg√§nglig f√∂r evaluering</li>
        </ul>
        
        <h3>Efterf√∂ljande steg</h3>
        <ul>
          <li><strong>Gateway "Gateway_0f8c0ne":</strong> Merge gateway som samlar fl√∂den fr√•n evaluate-fastighet och evaluate-bostadsratt</li>
          <li><strong>Object Information Subprocess End:</strong> N√§r evaluate-bostadsratt √§r klar slutf√∂rs object-information subprocessen</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Anv√§ndarupplevelse</h2>
      <p class="muted">Beskrivning av anv√§ndarupplevelsen f√∂r b√•de s√∂kande (kund) och anst√§lld (r√•dgivare/admin).</p>
      
      <h3>S√∂kande (Kund)</h3>
      <div class="card">
        <ul>
          <li><strong>Vad ser anv√§ndaren:</strong> Detta √§r en automatisk bakgrundsprocess (DMN businessRuleTask) som k√∂rs utan direkt anv√§ndarinteraktion. Kunden ser ingen direkt UI, men resultatet p√•verkar om bostadsr√§tten kan accepteras som s√§kerhet.</li>
          <li><strong>Steg:</strong> 
            <ul>
              <li>Processen k√∂rs automatiskt efter att bostadsr√§tts- och BRF-information har h√§mtats</li><li>Kunden forts√§tter med ans√∂kningsprocessen medan bed√∂mningen g√∂rs i bakgrunden</li><li>Vid REJECTED f√•r kunden information om varf√∂r bostadsr√§tten inte kan accepteras</li>
            </ul>
          </li>
          <li><strong>Interaktioner:</strong> Ingen direkt anv√§ndarinteraktion ‚Äì automatisk systemprocess</li>
          <li><strong>Design:</strong> N/A ‚Äì backend-process</li>
        </ul>
      </div>
      
      <h3>Anst√§lld (R√•dgivare/Admin)</h3>
      <div class="card">
        <ul>
          <li><strong>Vad ser anv√§ndaren:</strong> Handl√§ggare kan se status f√∂r bed√∂mningen i systemloggar eller admin-gr√§nssnitt. Bed√∂mningsresultatet visas i ans√∂knings√∂versikten tillsammans med bostadsr√§tts- och BRF-information, riskniv√•, och eventuella flaggor eller varningar.</li>
          <li><strong>Steg:</strong> 
            <ul>
              <li>Systemet k√∂r bed√∂mningen automatiskt efter att bostadsr√§tts- och BRF-information har h√§mtats</li><li>Handl√§ggare ser bed√∂mningsresultatet i ans√∂knings√∂versikten</li><li>Vid behov kan handl√§ggare granska bed√∂mningen och beg√§ra manuell granskning eller justering</li>
            </ul>
          </li>
          <li><strong>Interaktioner:</strong> Granska bed√∂mningsresultat, Se riskniv√• och motivering, Beg√§ra manuell granskning (vid behov)</li>
          <li><strong>Design:</strong> <a href="#figma-link">[L√§nk till Figma-design]</a></li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Funktionellt fl√∂de</h2>
      <p class="muted">Steg-f√∂r-steg beskrivning av processen.</p>
      <div class="card">
        <ol>
          <li>Epiken triggas automatiskt n√§r fetch-brf-information har slutf√∂rts och bostadsr√§tts- och BRF-information √§r tillg√§nglig.</li><li>DMN-motorn l√§ser in relevanta indata: bostadsr√§ttsv√§rde, f√∂reningsskuld, LTV-ratio, plats, och andra bostadsr√§ttsegenskaper fr√•n bostadsr√§tts- och BRF-information.</li><li>DMN-regeln utv√§rderar indata mot beslutslogik och aff√§rsregler f√∂r bostadsr√§ttsbed√∂mning.</li><li>Regeln bed√∂mer bostadsr√§ttens v√§rde, f√∂reningsskuld, LTV-ratio, och plats f√∂r att avg√∂ra om bostadsr√§tten kan accepteras som s√§kerhet.</li><li>Regeln returnerar ett beslut: APPROVED (kan anv√§ndas som s√§kerhet) eller REJECTED (kan inte anv√§ndas som s√§kerhet) tillsammans med riskniv√• (t.ex. LOW, MEDIUM, HIGH) och motivering.</li><li>Resultatet sparas i processens datastore tillsammans med riskniv√•, motivering, och eventuella flaggor.</li><li>Beroende p√• resultat forts√§tter processen: APPROVED ‚Üí forts√§tt till n√§sta steg, REJECTED ‚Üí processen kan avslutas eller flaggas f√∂r manuell granskning.</li>
        </ol>
        <p><strong>Beslutslogik:</strong> Epiken √§r en businessRuleTask d√§r DMN-motorn k√∂r beslutslogik. Gateway "objects-valid" anv√§nder resultatet f√∂r att avg√∂ra om processen ska forts√§tta (All/Some ‚Üí forts√§tt) eller stoppas (None ‚Üí processen avslutas med fel).</p>
        <p><strong>Felhantering:</strong> Om bostadsr√§tts- eller BRF-information saknas eller √§r ofullst√§ndig kan regeln inte k√∂ras och processen flaggas f√∂r manuell hantering. Om DMN-regeln inte kan returnera ett beslut loggas felet och processen kan avbrytas eller skickas till manuell granskning.</p>
        <p><strong>Edge cases:</strong> Bostadsr√§tter med os√§ker v√§rdering (kan kr√§va manuell granskning), bostadsr√§tter med unika egenskaper utan j√§mf√∂relseobjekt (kan kr√§va manuell bed√∂mning), bostadsr√§tter med ofullst√§ndig information (kan kr√§va komplettering), bostadsr√§tter med h√∂ga LTV-ratio eller f√∂reningsskuld (kan kr√§va manuell granskning), bostadsr√§tter i riskomr√•den (kan kr√§va manuell bed√∂mning).</p>
      </div>
      
      <details>
        <summary>Sekvensdiagram - Bostadsr√§ttsbed√∂mning</summary>
        <div class="mermaid">
sequenceDiagram
    participant Camunda as BPMN Engine<br/>(Camunda)
    participant Service as Decision Service<br/>(Evaluate Bostadsr√§tt)
    participant BostadsrattStore as Bostadsr√§tt Information Service
    participant BRFStore as BRF Information Service
    participant DMN as DMN Decision Engine
    participant AppDB as Application DB
    
    Note over Camunda: Triggas efter<br/>fetch-brf-information
    Camunda->>Service: Exekvera evaluate-bostadsratt
    Service->>BostadsrattStore: H√§mta bostadsr√§ttsinformation<br/>(v√§rde, storlek, bygg√•r)
    BostadsrattStore-->>Service: Bostadsr√§ttsinformation
    
    Service->>BRFStore: H√§mta BRF-information<br/>(f√∂reningsskuld, avgifter)
    BRFStore-->>Service: BRF-information
    
    Service->>Service: Ber√§kna LTV-ratio<br/>(l√•nebelopp / bostadsr√§ttsv√§rde)
    Service->>DMN: Anropa DMN-regel<br/>(bostadsr√§ttsv√§rde, f√∂reningsskuld, LTV, plats)
    DMN->>DMN: Applicera beslutslogik<br/>(DMN Decision Table)
    DMN-->>Service: Beslut (APPROVED/REJECTED)<br/>+ riskniv√• + motivering
    
    Service->>AppDB: Spara bed√∂mningsresultat<br/>+ riskniv√• + motivering
    AppDB-->>Service: Bekr√§ftelse
    Service->>Camunda: Success + beslut
    Camunda->>Camunda: Gateway "objects-valid"<br/>avg√∂r n√§sta steg
        </div>
        <p class="muted">Sekvensdiagram visar tidslinje f√∂r interaktioner: BPMN Engine triggar Decision Service, som h√§mtar data fr√•n Bostadsr√§tt och BRF Information Services, ber√§knar LTV-ratio, anropar DMN Decision Engine f√∂r beslutslogik, sparar beslut, och gateway avg√∂r om processen forts√§tter eller avslutas.</p>
      </details>
    </section>

    <section class="doc-section">
      <h2>Inputs & Datak√§llor</h2>
      <p class="muted">Beskrivning av inputs och datak√§llor (interna och externa).</p>
      
      <h3>Inputs</h3>
      <p class="muted">Data som epiken tar emot fr√•n f√∂reg√•ende steg eller anv√§ndaren.</p>
      <table>
        <tr>
          <th>Input</th>
          <th>K√§lla</th>
          <th>Typ</th>
          <th>Obligatoriskt</th>
          <th>Beskrivning</th>
        </tr>
        <tr>
          <td>Bostadsr√§ttsinformation (v√§rde, storlek, bygg√•r, typ, plats)</td>
          <td>Bostadsr√§tt Information Service (fr√•n fetch-bostadsratts-information)</td>
          <td>BostadsrattData</td>
          <td>Ja</td>
          <td>Bostadsr√§ttsinformation som anv√§nds f√∂r bed√∂mning</td>
        </tr>
        <tr>
          <td>BRF-information (f√∂reningsskuld, avgifter, ekonomiska nyckeltal)</td>
          <td>BRF Information Service (fr√•n fetch-brf-information)</td>
          <td>BRFData</td>
          <td>Ja</td>
          <td>BRF-information som anv√§nds f√∂r bed√∂mning</td>
        </tr>
        <tr>
          <td>L√•nebelopp</td>
          <td>Ans√∂kningsdata</td>
          <td>Number</td>
          <td>Ja</td>
          <td>F√∂r att ber√§kna LTV-ratio (loan-to-value)</td>
        </tr>
        <tr>
          <td>Bostadsr√§ttsv√§rde</td>
          <td>Bostadsr√§tt Information Service</td>
          <td>Number</td>
          <td>Ja</td>
          <td>F√∂r att ber√§kna LTV-ratio och bed√∂ma bostadsr√§ttens v√§rde</td>
        </tr>
      </table>

      <h3>Datak√§llor</h3>
      <p class="muted">System och k√§llor som epiken h√§mtar data fr√•n.</p>
      
      <h4>Interna datak√§llor</h4>
      <ul>
        <li><strong>Bostadsr√§tt Information Service:</strong> Lagrar bostadsr√§ttsinformation fr√•n fetch-bostadsratts-information</li>
        <li><strong>BRF Information Service:</strong> Lagrar BRF-information fr√•n fetch-brf-information</li>
        <li><strong>Application DB:</strong> Ans√∂kningsdata och processkontext</li>
      </ul>
    </section>

    <section class="doc-section">
      <h2>Outputs</h2>
      <p class="muted">Data som skapas, uppdateras eller skickas vidare.</p>
      <table>
        <tr>
          <th>Output</th>
          <th>Mottagare</th>
          <th>Typ</th>
          <th>Beskrivning</th>
        </tr>
        <tr>
          <td>Bed√∂mningsresultat (APPROVED/REJECTED)</td>
          <td>Gateway "objects-valid", efterf√∂ljande steg</td>
          <td>AssessmentResult</td>
          <td>Beslut fr√•n DMN-regeln: APPROVED (kan anv√§ndas som s√§kerhet) eller REJECTED (kan inte anv√§ndas som s√§kerhet)</td>
        </tr>
        <tr>
          <td>Riskniv√• (LOW/MEDIUM/HIGH)</td>
          <td>Processkontext, loggsystem</td>
          <td>RiskLevel</td>
          <td>Riskniv√• baserad p√• bostadsr√§ttsv√§rde, f√∂reningsskuld, LTV-ratio, och plats f√∂r att bed√∂ma bostadsr√§ttens riskprofil</td>
        </tr>
        <tr>
          <td>Motivering och flaggor</td>
          <td>Processkontext, loggsystem</td>
          <td>AssessmentReasoning</td>
          <td>Detaljerad motivering f√∂r beslutet, ber√§knad LTV-ratio, f√∂reningsskuld, och eventuella flaggor eller varningar</td>
        </tr>
        <tr>
          <td>Validerad bostadsr√§ttsstatus</td>
          <td>Efterf√∂ljande steg</td>
          <td>ValidatedApartment</td>
          <td>Status som anv√§nds av gateway "objects-valid" f√∂r att avg√∂ra om processen ska forts√§tta eller stoppas</td>
        </tr>
      </table>
    </section>

    <section class="doc-section">
      <h2>Arkitektur & Systeminteraktioner</h2>
      <p class="muted">Beskrivning av systemarkitektur, integrationer och teknisk stack.</p>
      <div class="card">
        <ul>
          <li><strong>System som interagerar:</strong>
            <ul>
              <li><strong>DMN Decision Engine:</strong> Camunda DMN eller liknande f√∂r att k√∂ra beslutslogik</li>
              <li><strong>Bostadsr√§tt Information Service:</strong> Lagrar bostadsr√§ttsinformation fr√•n fetch-bostadsratts-information</li>
              <li><strong>BRF Information Service:</strong> Lagrar BRF-information fr√•n fetch-brf-information</li>
              <li><strong>Application DB:</strong> PostgreSQL-databas f√∂r ans√∂kningsdata och processkontext</li>
            </ul>
          </li>
          
          <li><strong>Integrationer:</strong>
            <ul>
              <li><strong>API-integrationer:</strong> REST API f√∂r att k√∂ra DMN-beslutsregel. API:et exponerar endpoint /api/dmn/evaluate-bostadsratt som tar indata (bostadsr√§ttsv√§rde, f√∂reningsskuld, LTV-ratio, plats) och returnerar beslut (APPROVED/REJECTED + riskniv√•).</li>
              <li><strong>Event-integrationer:</strong> Processen triggas av BPMN event efter fetch-brf-information. Vid lyckad bed√∂mning kan events publiceras f√∂r efterf√∂ljande steg.</li>
              <li><strong>Databas-integrationer:</strong> PostgreSQL f√∂r ans√∂kningsdata. Bed√∂mningsresultat sparas i Application DB f√∂r anv√§ndning i efterf√∂ljande steg.</li>
            </ul>
          </li>
          
          <li><strong>Teknisk stack:</strong>
            <ul>
              <li>BPMN-processmotor (Camunda) f√∂r orkestrering</li>
              <li>DMN Decision Engine f√∂r beslutslogik</li>
              <li>PostgreSQL f√∂r datalagring</li>
              <li>Loggning via centraliserat loggsystem</li>
            </ul>
          </li>
          
          <li><strong>Arkitekturdiagram:</strong>
            <details>
              <summary>C4 System Context Diagram</summary>
              <div class="mermaid">
graph TB
    Customer[üë§ Customer<br/>Kund]
    Handler[üë§ Handler<br/>Handl√§ggare]
    
    Epic[Evaluate Bostadsr√§tt<br/>businessRuleTask]
    
    DMNEngine[DMN Decision Engine<br/>Bostadsr√§ttsbed√∂mning]
    BostadsrattStore[(Bostadsr√§tt Information Service<br/>Bostadsr√§ttsinfo)]
    BRFStore[(BRF Information Service<br/>BRF-info)]
    AppDB[(Application DB<br/>PostgreSQL)]
    
    Customer -.->|Triggar via<br/>ans√∂kan| Epic
    Handler -.->|Granskar<br/>resultat| Epic
    
    Epic -->|Anv√§nder| DMNEngine
    Epic -->|L√§ser| BostadsrattStore
    Epic -->|L√§ser| BRFStore
    Epic -->|L√§ser/Sparar<br/>ans√∂kningsdata| AppDB
    
    style Epic fill:#1d4ed8,color:#fff
    style DMNEngine fill:#f59e0b,color:#fff
    style BostadsrattStore fill:#10b981,color:#fff
    style BRFStore fill:#10b981,color:#fff
    style AppDB fill:#10b981,color:#fff
              </div>
              <p class="muted">System Context Diagram visar epic i centrum med DMN Decision Engine, Bostadsr√§tt och BRF Information Services, Application DB, och anv√§ndare (Customer, Handler).</p>
            </details>
            
            <details>
              <summary>Komponentdiagram</summary>
              <div class="mermaid">
graph TB
    BPMN[BPMN Engine<br/>Camunda]
    DecisionService[Decision Service<br/>Evaluate Bostadsr√§tt]
    DMNEngine[DMN Decision Engine<br/>Bostadsr√§ttsbed√∂mning]
    BostadsrattStore[Bostadsr√§tt Information Service<br/>Bostadsr√§ttsinfo]
    BRFStore[BRF Information Service<br/>BRF-info]
    AppDB[Application DB<br/>PostgreSQL]
    
    BPMN -->|Orkestrerar| DecisionService
    DecisionService -->|Anv√§nder| DMNEngine
    DecisionService -->|L√§ser| BostadsrattStore
    DecisionService -->|L√§ser| BRFStore
    DecisionService -->|L√§ser/Sparar| AppDB
    
    DMNEngine -->|K√∂r beslutslogik| DecisionService
    
    style BPMN fill:#1d4ed8,color:#fff
    style DecisionService fill:#3b82f6,color:#fff
    style DMNEngine fill:#f59e0b,color:#fff
    style BostadsrattStore fill:#10b981,color:#fff
    style BRFStore fill:#10b981,color:#fff
    style AppDB fill:#10b981,color:#fff
              </div>
              <p class="muted">Komponentdiagram visar huvudkomponenter: BPMN Engine orkestrerar Decision Service, som anv√§nder DMN Decision Engine f√∂r beslutslogik, l√§ser data fr√•n Bostadsr√§tt och BRF Information Services, och sparar beslut i Application DB.</p>
            </details>
          </li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Aff√§rsregler & Beroenden</h2>
      <p class="muted">Beskrivning av aff√§rsregler, kreditregler och beroenden.</p>
      <div class="card">
        <h3>Aff√§rsregler</h3>
        <ul>
          <li><strong>DMN-beslutslogik:</strong> Regeln implementeras som DMN (Decision Model and Notation) beslutsregel med beslutslogik baserad p√• bostadsr√§ttsv√§rde, f√∂reningsskuld, LTV-ratio, och plats. Beslutslogiken kan uppdateras utan kod√§ndringar.</li>
          <li><strong>Bostadsr√§ttsbed√∂mningskriterier:</strong> Grundl√§ggande kriterier f√∂r godk√§nnande: bostadsr√§ttsv√§rde (t.ex. minimum v√§rde), f√∂reningsskuld (t.ex. maximum skuld per kvadratmeter), LTV-ratio (t.ex. maximum 85%), och plats (t.ex. acceptabel plats).</li>
          <li><strong>Riskkategorisering:</strong> Bostadsr√§tter kategoriseras i riskkategorier (LOW, MEDIUM, HIGH) baserat p√• bostadsr√§ttsv√§rde, f√∂reningsskuld, LTV-ratio, och plats. Riskkategorin anv√§nds f√∂r att bed√∂ma bostadsr√§ttens riskprofil och kan p√•verka l√•nevillkor.</li>
          <li><strong>LTV-ratio ber√§kning:</strong> LTV-ratio ber√§knas som l√•nebelopp / bostadsr√§ttsv√§rde. Bostadsr√§tter med h√∂g LTV-ratio (> 85%) bed√∂ms ha h√∂gre risk och kan avvisas eller kr√§va manuell granskning.</li>
          <li><strong>F√∂reningsskuld:</strong> F√∂reningsskuld per kvadratmeter eller total f√∂reningsskuld bed√∂ms f√∂r att avg√∂ra om BRF:en har h√§lsosam ekonomi. H√∂g f√∂reningsskuld kan leda till avslag.</li>
          <li><strong>Policykrav:</strong> Policykrav f√∂r risk, s√§kerhet och produktvillkor ska vara sp√•rbara via kopplade regler. Regeln omfattar grundl√§ggande bostadsr√§ttsbed√∂mning, inte fullst√§ndig fastighetsv√§rdering.</li>
        </ul>
        
        <h3>DMN Decision Table</h3>
        <p class="muted">Beslutslogik f√∂r bostadsr√§ttsbed√∂mning baserat p√• bostadsr√§ttsv√§rde, f√∂reningsskuld, LTV-ratio, och plats.</p>
        <table class="dmn-table">
          <tr>
            <th colspan="4" class="dmn-input">Input</th>
            <th colspan="3" class="dmn-output">Output</th>
          </tr>
          <tr>
            <th>Bostadsr√§ttsv√§rde<br/>(SEK)</th>
            <th>F√∂reningsskuld<br/>(SEK/m¬≤)</th>
            <th>LTV-ratio<br/>(%)</th>
            <th>Plats</th>
            <th>Beslut</th>
            <th>Riskniv√•</th>
            <th>Motivering</th>
          </tr>
          <tr>
            <td>‚â• 1.5M</td>
            <td>‚â§ 5000</td>
            <td>‚â§ 85%</td>
            <td>Acceptabel</td>
            <td><strong>APPROVED</strong></td>
            <td>LOW</td>
            <td>Alla kriterier uppfyllda. God s√§kerhet.</td>
          </tr>
          <tr>
            <td>‚â• 1.5M</td>
            <td>‚â§ 5000</td>
            <td>80-85%</td>
            <td>Acceptabel</td>
            <td><strong>APPROVED</strong></td>
            <td>MEDIUM</td>
            <td>Gr√§nsv√§rden men acceptabel risk. Kr√§ver manuell granskning.</td>
          </tr>
          <tr>
            <td>‚â• 1.5M</td>
            <td>‚â§ 5000</td>
            <td>> 85%</td>
            <td>Acceptabel</td>
            <td><strong>REJECTED</strong></td>
            <td>HIGH</td>
            <td>LTV-ratio f√∂r h√∂g. Otillr√§cklig s√§kerhet.</td>
          </tr>
          <tr>
            <td>‚â• 1.5M</td>
            <td>> 5000</td>
            <td>‚â§ 85%</td>
            <td>Acceptabel</td>
            <td><strong>REJECTED</strong></td>
            <td>MEDIUM</td>
            <td>F√∂reningsskuld f√∂r h√∂g. Os√§ker BRF-ekonomi.</td>
          </tr>
          <tr>
            <td>&lt; 1.5M</td>
            <td>‚â§ 5000</td>
            <td>‚â§ 85%</td>
            <td>Acceptabel</td>
            <td><strong>REJECTED</strong></td>
            <td>MEDIUM</td>
            <td>Bostadsr√§ttsv√§rde f√∂r l√•gt. Otillr√§cklig s√§kerhet.</td>
          </tr>
          <tr>
            <td>‚â• 1.5M</td>
            <td>‚â§ 5000</td>
            <td>‚â§ 85%</td>
            <td>Riskomr√•de</td>
            <td><strong>REJECTED</strong></td>
            <td>HIGH</td>
            <td>Plats i riskomr√•de. H√∂g risk.</td>
          </tr>
        </table>
        <p class="muted"><strong>Hit Policy:</strong> FIRST (f√∂rsta matchande regel anv√§nds)</p>
        
        <h3>Tr√∂skelv√§rden och Prioritering</h3>
        <table>
          <tr>
            <th>Kriterium</th>
            <th>Tr√∂skelv√§rde</th>
            <th>Prioritering</th>
            <th>Beskrivning</th>
          </tr>
          <tr>
            <td>Bostadsr√§ttsv√§rde</td>
            <td>Minimum 1.5M SEK</td>
            <td>H√∂g</td>
            <td>Bostadsr√§tter med v√§rde under 1.5M SEK avvisas automatiskt</td>
          </tr>
          <tr>
            <td>LTV-ratio</td>
            <td>Maximum 85%</td>
            <td>H√∂g</td>
            <td>Bostadsr√§tter med LTV-ratio √∂ver 85% avvisas automatiskt</td>
          </tr>
          <tr>
            <td>F√∂reningsskuld</td>
            <td>Maximum 5000 SEK/m¬≤</td>
            <td>H√∂g</td>
            <td>Bostadsr√§tter med f√∂reningsskuld √∂ver 5000 SEK/m¬≤ avvisas automatiskt</td>
          </tr>
          <tr>
            <td>Plats</td>
            <td>Acceptabel plats</td>
            <td>Kritisk</td>
            <td>Bostadsr√§tter i riskomr√•den avvisas automatiskt oavsett andra kriterier</td>
          </tr>
          <tr>
            <td>LTV-ratio (gr√§nsv√§rden)</td>
            <td>80-85%</td>
            <td>Medium</td>
            <td>Bostadsr√§tter med LTV-ratio 80-85% kan godk√§nnas men kr√§ver manuell granskning</td>
          </tr>
        </table>
        
        <details>
          <summary>Regeltr√§d / Decision Tree</summary>
          <div class="mermaid">
flowchart TD
    Start[Evaluate Bostadsr√§tt<br/>Bostadsr√§ttsbed√∂mning]
    
    CheckValue{Bostadsr√§ttsv√§rde<br/>‚â• 1.5M SEK?}
    CheckDebt{F√∂reningsskuld<br/>‚â§ 5000 SEK/m¬≤?}
    CheckLTV{LTV-ratio<br/>‚â§ 85%?}
    CheckLocation{Plats<br/>Acceptabel?}
    
    Rejected1[REJECTED<br/>Risk: MEDIUM<br/>Bostadsr√§ttsv√§rde f√∂r l√•gt]
    Rejected2[REJECTED<br/>Risk: MEDIUM<br/>F√∂reningsskuld f√∂r h√∂g]
    Rejected3[REJECTED<br/>Risk: HIGH<br/>LTV-ratio f√∂r h√∂g]
    Rejected4[REJECTED<br/>Risk: HIGH<br/>Plats i riskomr√•de]
    
    Approved1[APPROVED<br/>Risk: LOW<br/>Alla kriterier uppfyllda]
    Approved2[APPROVED<br/>Risk: MEDIUM<br/>Gr√§nsv√§rden, kr√§ver granskning]
    
    Start --> CheckValue
    CheckValue -->|Nej| Rejected1
    CheckValue -->|Ja| CheckDebt
    CheckDebt -->|Nej| Rejected2
    CheckDebt -->|Ja| CheckLocation
    CheckLocation -->|Nej| Rejected4
    CheckLocation -->|Ja| CheckLTV
    CheckLTV -->|Nej| Rejected3
    CheckLTV -->|Ja| Approved1
    
    CheckLTV -->|80-85%| Approved2
    
    style Start fill:#1d4ed8,color:#fff
    style CheckValue fill:#fbbf24,color:#000
    style CheckDebt fill:#fbbf24,color:#000
    style CheckLTV fill:#fbbf24,color:#000
    style CheckLocation fill:#fbbf24,color:#000
    style Rejected1 fill:#ef4444,color:#fff
    style Rejected2 fill:#ef4444,color:#fff
    style Rejected3 fill:#ef4444,color:#fff
    style Rejected4 fill:#ef4444,color:#fff
    style Approved1 fill:#10b981,color:#fff
    style Approved2 fill:#f59e0b,color:#fff
          </div>
          <p class="muted">Regeltr√§d visar beslutslogik: F√∂rst kontrolleras bostadsr√§ttsv√§rde, sedan f√∂reningsskuld, plats, och slutligen LTV-ratio. Varje steg kan leda till APPROVED eller REJECTED med olika riskniv√•er.</p>
        </details>
      </div>
    </section>

    <section class="doc-section">
      <h2>API Dokumentation</h2>
      <p class="muted">Beskrivning av API-endpoints som anv√§nds eller exponeras.</p>
      
      <h3>API-endpoints (exponerade)</h3>
      <table>
        <tr>
          <th>Endpoint</th>
          <th>Metod</th>
          <th>Request</th>
          <th>Response</th>
          <th>Felkoder</th>
        </tr>
        <tr>
          <td><code>/api/evaluate-bostadsratt</code></td>
          <td>POST</td>
          <td><code>{ "bostadsr√§ttsInformation": {...}, "brfInformation": {...}, "bostadsr√§ttsv√§rde": "number", "f√∂reningsskuld": "number", "plats": "string", "LTV": "number", "applicationId": "uuid" }</code></td>
          <td><code>{ "beslut": "APPROVED" | "REJECTED", "riskkategori": "string", "motivering": "string", "status": "success" }</code></td>
          <td>400 (Bad Request), 500 (Server Error)</td>
        </tr>
      </table>
      
      <h3>DMN Decision Table</h3>
      <div class="card">
        <ul>
          <li><strong>DMN-fil:</strong> evaluate-bostadsratt.dmn</li>
          <li><strong>Besluts-ID:</strong> evaluate-bostadsratt</li>
          <li><strong>Hit Policy:</strong> FIRST (f√∂rsta matchande regel anv√§nds)</li>
          <li><strong>Inputs:</strong> bostadsr√§ttsv√§rde, f√∂reningsskuld, plats, LTV-ratio</li>
          <li><strong>Outputs:</strong> beslut (APPROVED/REJECTED), riskkategori, motivering</li>
        </ul>
      </div>
      
      <h3>Autentisering</h3>
      <div class="card">
        <ul>
          <li><strong>Exponerad endpoint:</strong> Kr√§ver OAuth 2.0 Bearer token i Authorization header</li>
          <li><strong>DMN Engine:</strong> Intern autentisering via API Gateway</li>
        </ul>
      </div>
      
      <h3>Felhantering</h3>
      <div class="card">
        <ul>
          <li><strong>400 Bad Request:</strong> Ogiltig input (t.ex. saknade obligatoriska f√§lt eller ogiltiga v√§rden)</li>
          <li><strong>500 Server Error:</strong> Internt serverfel eller DMN Engine-fel</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Felhantering & Edge Cases</h2>
      <p class="muted">Beskrivning av felhantering och edge cases.</p>
      
      <h3>Tekniska fel</h3>
      <div class="card">
        <ul>
          <li><strong>DMN Engine-fel:</strong> Om DMN-motorn inte kan k√∂ras (500 Server Error, timeout) ska systemet logga felet och flagga processen f√∂r manuell granskning. √ñverv√§g fallback-beslut (t.ex. REVIEW) vid tekniska fel f√∂r att undvika att processen stoppas helt.</li>
          <li><strong>DMN-modell saknas:</strong> Om DMN-modellen inte hittas (404 Not Found) ska systemet logga felet och flagga processen f√∂r manuell granskning. Detta kan h√§nda vid deployment eller modelluppdateringar.</li>
          <li><strong>Databasfel:</strong> Vid databasfel (connection timeout, deadlock) n√§r indata h√§mtas ska processen flaggas f√∂r manuell hantering och felet loggas med detaljerad information.</li>
        </ul>
      </div>
      
      <h3>Aff√§rsrelaterade fel</h3>
      <div class="card">
        <ul>
          <li><strong>Obligatoriska indata saknas:</strong> Om obligatoriska indata saknas (t.ex. bostadsr√§ttsv√§rde, f√∂reningsskuld, plats, LTV) ska systemet logga felet och flagga processen f√∂r manuell granskning. Processen kan inte forts√§tta utan dessa data.</li>
          <li><strong>Ogiltiga indata:</strong> Om indata √§r ogiltiga (t.ex. negativt bostadsr√§ttsv√§rde, ogiltig LTV-ratio) ska systemet validera och flagga f√∂r manuell verifiering med tydligt felmeddelande.</li>
        </ul>
      </div>
      
      <h3>Edge cases</h3>
      <div class="card">
        <ul>
          <li><strong>Gr√§nsfall:</strong> Bostadsr√§tter som ligger precis p√• gr√§nsen f√∂r bed√∂mningskriterier (t.ex. bostadsr√§ttsv√§rde precis p√• minimum, f√∂reningsskuld precis p√• gr√§ns) kan returnera REVIEW f√∂r manuell bed√∂mning. Systemet ska hantera dessa gr√§nsfall korrekt.</li>
          <li><strong>Os√§ker v√§rdering:</strong> Om bostadsr√§ttsv√§rdering √§r os√§ker (t.ex. f√• j√§mf√∂relseobjekt) ska systemet flagga f√∂r manuell granskning. Systemet ska logga varf√∂r bed√∂mningen √§r os√§ker.</li>
        </ul>
      </div>
      
      <h3>Retry-strategier</h3>
      <div class="card">
        <ul>
          <li><strong>DMN Engine:</strong> Retry med exponentiell backoff (1s, 2s, 4s) f√∂r tillf√§lliga fel (timeout, 503 Service Unavailable). Max 2 f√∂rs√∂k innan fallback-beslut (REVIEW) anv√§nds.</li>
          <li><strong>Fallback-beslut:</strong> Vid tekniska fel kan systemet anv√§nda fallback-beslut (REVIEW) f√∂r att undvika att processen stoppas helt. Detta ger manuell granskning m√∂jlighet att bed√∂ma bostadsr√§tten.</li>
        </ul>
      </div>
    </section>

    <section class="doc-section">
      <h2>Relaterade noder</h2>
      <p class="muted">L√§nkar till relaterade epics, feature goals och business rules.</p>
      
      <details>
        <summary>Beroendediagram</summary>
        <div class="mermaid">
flowchart LR
    Previous[fetch-bostadsratts-information<br/>serviceTask]
    Current[evaluate-bostadsratt<br/>businessRuleTask]
    Next[fetch-brf-information<br/>serviceTask]
    ObjectsValid{objects-valid?<br/>Gateway}
    End[Object Information<br/>Subprocess End]
    
    Previous -->|Input till| Current
    Current --> Next
    Next --> ObjectsValid
    ObjectsValid -->|All/Some/None| End
    
    style Current fill:#f59e0b,color:#fff
    style Previous fill:#3b82f6,color:#fff
    style Next fill:#3b82f6,color:#fff
    style ObjectsValid fill:#fbbf24,color:#000
        </div>
        <p class="muted">Beroendediagram visar: fetch-bostadsratts-information ‚Üí evaluate-bostadsratt ‚Üí fetch-brf-information ‚Üí objects-valid ‚Üí End.</p>
      </details>
      
      <h3>F√∂reg√•ende steg</h3>
      <ul>
        <li><strong>fetch-bostadsratts-information:</strong> M√•ste vara slutf√∂rd f√∂r att bostadsr√§ttsinformation ska vara tillg√§nglig f√∂r bed√∂mning</li>
      </ul>
      
      <h3>Efterf√∂ljande steg</h3>
      <ul>
        <li><strong>fetch-brf-information:</strong> H√§mtar BRF-information efter bostadsr√§ttsbed√∂mning (anv√§nder organisationsnummer fr√•n bed√∂mningen)</li>
        <li><strong>objects-valid:</strong> Gateway som avg√∂r om objekt √§r giltiga baserat p√• bed√∂mningsresultat (All/Some/None)</li>
      </ul>
      
      <h3>Parallella steg</h3>
      <ul>
        <li><strong>evaluate-fastighet:</strong> K√∂rs parallellt om object-type √§r "Sm√•hus"</li>
      </ul>
      
      <h3>Business Rules</h3>
      <ul>
        <li><strong>DMN-modell:</strong> evaluate-bostadsratt.dmn inneh√•ller beslutslogik och aff√§rsregler</li>
        <li><strong>Bed√∂mningskriterier:</strong> Bostadsr√§ttsv√§rde, f√∂reningsskuld, plats, LTV-ratio</li>
      </ul>
    </section>
  </div>
</body>
</html>

